# システムアーキテクチャ設計書

## 1. 概要

### 1.1 目的
本書は、Traincrew発車メロディー連動システムのアーキテクチャ設計を定義する。

### 1.2 対象読者
- 開発者
- システム保守担当者
- レビュー担当者

### 1.3 参照ドキュメント
- 要件定義書.md

## 2. システムアーキテクチャ概要

### 2.1 アーキテクチャスタイル
本システムは、以下のアーキテクチャパターンを採用する：

- **レイヤードアーキテクチャ**: プレゼンテーション層、アプリケーション層、ドメイン層、インフラストラクチャ層の4層構成
- **Repository/Serviceパターン**: ビジネスロジックとデータアクセスの分離
- **依存性注入（DI）**: Microsoft.Extensions.DependencyInjectionを使用した疎結合設計

### 2.2 技術スタック

| カテゴリ | 技術 | バージョン | 用途 |
|---------|------|-----------|------|
| フレームワーク | .NET | 8.0 | 実行環境 |
| UIフレームワーク | WPF | .NET 8 | GUI実装 |
| DIコンテナ | Microsoft.Extensions.DependencyInjection | 8.0+ | 依存性注入 |
| 音声再生 | MediaPlayer (WPF) | .NET 8 | メロディー・音声再生 |
| 音声解析 | FFmpeg | 最新安定版 | メロディー長取得 |
| 通信 | WebSocket (System.Net.WebSockets) | .NET 8 | Traincrewゲーム連携 |
| 外部DLL | TrainCrewInput.dll | - | ゲーム状態取得 |

## 3. レイヤー構成

### 3.1 レイヤー構成図

```
┌─────────────────────────────────────────────────┐
│  Presentation Layer (プレゼンテーション層)       │
│  - MainWindow.xaml / MainWindow.xaml.cs         │
│  - その他UIコンポーネント                        │
└─────────────────────────────────────────────────┘
                      ↓ 依存
┌─────────────────────────────────────────────────┐
│  Application Layer (アプリケーション層)          │
│  - Services (ビジネスロジック)                   │
│    - MelodyControlService                       │
│    - AutoModeService                            │
│    - AudioPlaybackService                       │
└─────────────────────────────────────────────────┘
                      ↓ 依存
┌─────────────────────────────────────────────────┐
│  Domain Layer (ドメイン層)                       │
│  - Models (ドメインモデル)                       │
│  - Interfaces (抽象定義)                         │
└─────────────────────────────────────────────────┘
                      ↑ 実装
┌─────────────────────────────────────────────────┐
│  Infrastructure Layer (インフラストラクチャ層)   │
│  - Repositories (データアクセス)                 │
│    - TrackRepository (CSV読み込み)              │
│  - ExternalServices (外部連携)                  │
│    - TraincrewGameService                       │
│    - FFmpegService                              │
│  - AudioServices                                │
│    - MediaPlayerWrapper                         │
└─────────────────────────────────────────────────┘
```

### 3.2 各レイヤーの責務

#### 3.2.1 Presentation Layer（プレゼンテーション層）
**責務**:
- ユーザーインターフェースの表示
- ユーザー入力の受け付け
- アプリケーション層への処理委譲
- UI状態の管理（ボタン有効/無効など）

**主要コンポーネント**:
- `MainWindow.xaml`: メインウィンドウのUI定義
- `MainWindow.xaml.cs`: UIイベントハンドリング

**依存関係**:
- Application Layerのサービスに依存
- Domain Layerのモデルを参照可能

#### 3.2.2 Application Layer（アプリケーション層）
**責務**:
- ビジネスロジックの実装
- ユースケースの実現
- 複数のRepositoryやExternalServiceの調整
- トランザクション境界の定義

**主要コンポーネント**:
- `MelodyControlService`: メロディー制御の中核ロジック
- `AutoModeService`: 自動モード制御ロジック
- `AudioPlaybackService`: 音声再生の統合制御

**依存関係**:
- Domain Layerのインターフェースに依存
- Infrastructure Layerの実装を注入される

#### 3.2.3 Domain Layer（ドメイン層）
**責務**:
- ビジネスルールの定義
- ドメインモデルの定義
- インターフェースの定義（抽象化）

**主要コンポーネント**:
- `TrackInfo`: 駅・番線情報モデル
- `GameState`: ゲーム状態モデル
- `MelodyState`: メロディー再生状態モデル
- 各種インターフェース定義

**依存関係**:
- 他のレイヤーに依存しない（Pure Domain）

#### 3.2.4 Infrastructure Layer（インフラストラクチャ層）
**責務**:
- 外部システムとの連携
- データの永続化・読み込み
- 技術的な実装詳細の隠蔽

**主要コンポーネント**:
- `TrackRepository`: Track.csvの読み込み
- `TraincrewGameService`: Traincrewゲームとの通信
- `FFmpegService`: FFmpegを使った音声解析
- `MediaPlayerWrapper`: MediaPlayerのラップ

**依存関係**:
- Domain Layerのインターフェースを実装
- 外部ライブラリ・DLLに依存

## 4. プロジェクト構成

### 4.1 フォルダ構造

```
Traincrew_depMelody/
├── Traincrew_depMelody.csproj
├── App.xaml
├── App.xaml.cs
│
├── Presentation/              # プレゼンテーション層
│   ├── Views/
│   │   └── MainWindow.xaml
│   │   └── MainWindow.xaml.cs
│   └── (将来: 設定ウィンドウなど)
│
├── Application/               # アプリケーション層
│   └── Services/
│       ├── MelodyControlService.cs
│       ├── AutoModeService.cs
│       └── AudioPlaybackService.cs
│
├── Domain/                    # ドメイン層
│   ├── Models/
│   │   ├── TrackInfo.cs
│   │   ├── GameState.cs
│   │   ├── MelodyState.cs
│   │   └── AutoModeConfig.cs
│   └── Interfaces/
│       ├── Repositories/
│       │   └── ITrackRepository.cs
│       ├── Services/
│       │   ├── ITraincrewGameService.cs
│       │   ├── IFFmpegService.cs
│       │   └── IAudioPlayerService.cs
│       └── IMelodyControlService.cs
│
└── Infrastructure/            # インフラストラクチャ層
    ├── Repositories/
    │   └── TrackRepository.cs
    ├── ExternalServices/
    │   ├── TraincrewGameService.cs
    │   └── FFmpegService.cs
    └── AudioServices/
        └── MediaPlayerService.cs
```

### 4.2 名前空間構成

```csharp
Traincrew_depMelody
├── Presentation
│   └── Views
├── Application
│   └── Services
├── Domain
│   ├── Models
│   └── Interfaces
│       ├── Repositories
│       └── Services
└── Infrastructure
    ├── Repositories
    ├── ExternalServices
    └── AudioServices
```

## 5. 依存性注入（DI）設計

### 5.1 DIコンテナ設定

**App.xaml.cs** でDIコンテナを構成する。

```csharp
public partial class App : System.Windows.Application
{
    private ServiceProvider _serviceProvider;

    protected override void OnStartup(StartupEventArgs e)
    {
        base.OnStartup(e);

        var services = new ServiceCollection();
        ConfigureServices(services);
        _serviceProvider = services.BuildServiceProvider();

        var mainWindow = _serviceProvider.GetRequiredService<MainWindow>();
        mainWindow.Show();
    }

    private void ConfigureServices(IServiceCollection services)
    {
        // Presentation Layer
        services.AddSingleton<MainWindow>();

        // Application Layer
        services.AddSingleton<IMelodyControlService, MelodyControlService>();
        services.AddSingleton<IAutoModeService, AutoModeService>();
        services.AddSingleton<IAudioPlaybackService, AudioPlaybackService>();

        // Infrastructure Layer - Repositories
        services.AddSingleton<ITrackRepository, TrackRepository>();

        // Infrastructure Layer - External Services
        services.AddSingleton<ITraincrewGameService, TraincrewGameService>();
        services.AddSingleton<IFFmpegService, FFmpegService>();
        services.AddSingleton<IAudioPlayerService, MediaPlayerService>();

        // Configuration (将来的に設定ファイルから読み込み)
        services.AddSingleton<AppConfiguration>();
    }
}
```

### 5.2 ライフタイム管理

| コンポーネント | ライフタイム | 理由 |
|--------------|------------|------|
| MainWindow | Singleton | アプリケーション全体で1つのみ |
| MelodyControlService | Singleton | 状態を保持する必要がある |
| AutoModeService | Singleton | 状態を保持する必要がある |
| AudioPlaybackService | Singleton | 音声リソースの一元管理 |
| TrackRepository | Singleton | データキャッシュのため |
| TraincrewGameService | Singleton | WebSocket接続を保持 |
| FFmpegService | Singleton | ステートレスだが、頻繁に生成不要 |
| MediaPlayerService | Singleton | 音声リソースの一元管理 |

## 6. データフロー

### 6.1 基本データフロー（手動モード）

```
User Input (ONボタン押下)
  ↓
MainWindow.OnButton_Click()
  ↓
MelodyControlService.StartMelody()
  ↓
├→ TraincrewGameService.GetCurrentGameState()
│   ├→ WebSocket通信で軌道回路取得
│   └→ TrainCrewInput.dllでゲーム状態取得
│
├→ TrackRepository.FindTrackByCircuit()
│   └→ Track.csvから駅・番線を特定
│
└→ AudioPlaybackService.PlayMelody()
    └→ MediaPlayerService.PlayLoop()
```

### 6.2 自動モードデータフロー

```
Timer (16ms周期)
  ↓
AutoModeService.CheckAndExecute()
  ↓
├→ TraincrewGameService.GetCurrentGameState()
│
├→ 条件判定（到着後1秒、信号開通など）
│
└→ MelodyControlService.StartMelody() / StopMelody()
```

## 7. 非機能要件への対応

### 7.1 性能要件への対応

| 要件 | 実装方針 |
|-----|---------|
| ゲーム状態取得周期: 16ms | System.Threading.Timer を使用した定期実行 |
| ボタン押下から再生まで1秒以内 | 非同期処理の活用、音声ファイルの事前キャッシュ |
| UI応答性の維持 | async/await による非同期処理 |

### 7.2 拡張性要件への対応

| 要件 | 実装方針 |
|-----|---------|
| 新規駅・番線の追加 | TrackRepositoryがCSVから動的読み込み |
| メロディー追加 | ファイル名規則に従って配置するだけで対応 |
| 将来の機能追加 | インターフェースベースの設計により拡張容易 |

### 7.3 保守性要件への対応

| 要件 | 実装方針 |
|-----|---------|
| 依存性注入による疎結合 | Microsoft.Extensions.DependencyInjection使用 |
| Repository/Serviceパターン | レイヤー分離による責務の明確化 |
| インターフェースベース設計 | テスタビリティとモック化の容易性 |

## 8. 外部システム連携

### 8.1 Traincrewゲーム連携

**連携方式**:
1. **WebSocket通信** (ポート50300)
   - 軌道回路情報の取得
   - リアルタイムデータ取得

2. **TrainCrewInput.dll**
   - ゲーム画面状態
   - 列車状態
   - 信号情報
   - 乗務員種別

**実装クラス**: `TraincrewGameService`

### 8.2 FFmpeg連携

**連携方式**:
- プロセス起動によるコマンド実行
- 標準出力のパース

**用途**:
- 音声ファイルの長さ取得（自動モード用）

**実装クラス**: `FFmpegService`

### 8.3 CSVファイル連携

**対象ファイル**: `Csv/Track.csv`

**フォーマット**:
```csv
駅名,番線,対応軌道回路1,対応軌道回路2,対応軌道回路3
館浜,1,TC_001,TC_002,
館浜,2,TC_003,TC_004,TC_005
```

**実装クラス**: `TrackRepository`

## 9. エラーハンドリング戦略

### 9.1 エラー分類

| エラー種別 | 対応方針 | 例 |
|-----------|---------|---|
| 致命的エラー | アプリケーション終了 | DIコンテナ初期化失敗 |
| 回復可能エラー | ログ記録＋デフォルト動作 | 音声ファイル未存在 |
| 一時的エラー | リトライ | WebSocket接続失敗 |
| ユーザーエラー | メッセージ表示 | 不正なCSVフォーマット |

### 9.2 例外ハンドリング方針

- **Infrastructure Layer**: 外部システムエラーをキャッチし、ドメイン例外に変換
- **Application Layer**: ビジネスロジック例外をハンドリング
- **Presentation Layer**: 最終的なエラー表示とユーザー通知

## 10. ログ戦略

### 10.1 ログレベル

| レベル | 用途 | 例 |
|-------|------|---|
| Trace | 詳細なデバッグ情報 | メソッド呼び出しトレース |
| Debug | デバッグ情報 | 状態遷移、変数値 |
| Information | 一般的な情報 | メロディー再生開始/停止 |
| Warning | 警告 | デフォルトメロディー使用 |
| Error | エラー | 音声ファイル読み込み失敗 |
| Critical | 致命的エラー | アプリケーション起動失敗 |

### 10.2 ログ出力先

- **開発時**: コンソール出力
- **本番時**: ファイル出力（`Logs/app.log`）

### 10.3 ログライブラリ

- `Microsoft.Extensions.Logging` を使用
- 将来的にSerilogなど高機能ライブラリへの切り替え可能

## 11. 設定管理

### 11.1 設定項目

| 設定項目 | デフォルト値 | 格納場所（将来） |
|---------|------------|----------------|
| FFmpegパス | `C:\ffmpeg\bin\ffmpeg.exe` | appsettings.json |
| 音声ベースディレクトリ | `.\Audio\` | appsettings.json |
| TrackCSVパス | `.\Csv\Track.csv` | appsettings.json |
| WebSocketポート | 50300 | appsettings.json |
| ゲーム状態取得間隔 | 16ms | appsettings.json |

### 11.2 設定クラス

```csharp
public class AppConfiguration
{
    public string FFmpegPath { get; set; }
    public string AudioBaseDirectory { get; set; }
    public string TrackCsvPath { get; set; }
    public int WebSocketPort { get; set; }
    public int GameStatePollingInterval { get; set; }
}
```

## 12. スレッドモデル

### 12.1 UIスレッド

- WPF UIの描画・イベント処理
- `Dispatcher`を使ったUIスレッドへのマーシャリング

### 12.2 バックグラウンドスレッド

- ゲーム状態の定期取得（Timer）
- WebSocket通信
- 音声ファイル解析

### 12.3 スレッドセーフティ

- Serviceクラスは内部でロックを使用
- イミュータブルなモデルを使用
- `ConcurrentDictionary`などのスレッドセーフコレクション活用

## 13. セキュリティ考慮事項

### 13.1 ファイルアクセス

- CSVファイル読み込み時のパストラバーサル対策
- 音声ファイルパスの検証

### 13.2 外部プロセス実行

- FFmpeg実行時のコマンドインジェクション対策
- プロセス実行パラメータのサニタイズ

### 13.3 WebSocket通信

- localhost限定の通信
- タイムアウト設定

## 14. 将来の拡張に向けた設計

### 14.1 拡張ポイント

1. **設定ウィンドウ追加**
   - 新しいViewを追加
   - 設定サービスの追加

2. **キーボード操作機能**
   - グローバルホットキーサービスの追加
   - インターフェース経由で既存サービスに統合

3. **シリアルポート連携**
   - 新しいExternalServiceとして実装
   - 既存のMelodyControlServiceに統合

### 14.2 プラグインアーキテクチャ（検討事項）

将来的には以下のプラグイン機構を検討：
- 音声プレーヤーのプラグイン化
- 入力デバイスのプラグイン化
- メロディー選択ロジックのプラグイン化

## 15. 開発ガイドライン

### 15.1 コーディング規約

- C# Coding Conventions に準拠
- Async/Awaitの積極的な活用
- LINQ の活用
- Null許容参照型の有効化

### 15.2 命名規約

| 要素 | 規約 | 例 |
|-----|------|---|
| インターフェース | I + PascalCase | `IMelodyControlService` |
| クラス | PascalCase | `MelodyControlService` |
| メソッド | PascalCase | `StartMelody()` |
| プライベートフィールド | _camelCase | `_audioPlayer` |
| プロパティ | PascalCase | `CurrentState` |

### 15.3 ユニットテスト方針

- xUnit を使用
- Moq でモック作成
- カバレッジ目標: 80%以上（Application Layer, Domain Layer）
- Repository/ExternalServiceは統合テストで検証

## 16. ビルド・デプロイ

### 16.1 ビルド設定

- ターゲットフレームワーク: net8.0-windows
- プラットフォーム: x64
- 出力形式: 自己完結型実行ファイル

### 16.2 依存ファイル配置

```
実行フォルダ/
├── Traincrew_depMelody.exe
├── Csv/
│   └── Track.csv
├── Audio/
│   ├── Melody/
│   │   ├── 館浜_1.mp3
│   │   └── ...
│   └── Announcement/
│       ├── announcement1d.mp3
│       └── ...
└── Logs/
```

## 17. まとめ

本アーキテクチャ設計は以下の原則に基づいている：

1. **関心の分離**: レイヤードアーキテクチャによる明確な責務分離
2. **依存性の逆転**: インターフェースを介した疎結合設計
3. **拡張性**: 新機能追加が容易な構造
4. **保守性**: テスト可能で理解しやすいコード構成
5. **性能**: 非同期処理とリソース管理の最適化

これらにより、要件定義書に記載された機能を実現し、将来の拡張にも対応可能なシステムを構築する。
