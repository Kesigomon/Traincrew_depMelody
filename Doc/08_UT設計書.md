# UT設計書

## 1. 概要

### 1.1 目的
本書は、Traincrew発車メロディー連動システムのユニットテスト(UT)の設計を定義する。

### 1.2 参照ドキュメント
- 要件定義書.md
- 02_クラス設計書.md
- 03_インターフェース設計書.md
- 04_シーケンス図.md

### 1.3 テスト方針

#### 1.3.1 基本方針
- **テスト駆動開発(TDD)**: 可能な限りテストファーストで開発
- **依存性注入(DI)**: モック/スタブを活用した単体テスト
- **カバレッジ目標**: コードカバレッジ80%以上
- **テストフレームワーク**: xUnit
- **モックフレームワーク**: Moq

#### 1.3.2 テスト対象レイヤー
| レイヤー | テスト対象 | 備考 |
|---------|-----------|------|
| Domain | Models | ビジネスロジックのテスト |
| Application | Services | ユースケースのテスト |
| Infrastructure | Repositories, Services | 外部システム連携のテスト |
| Presentation | ViewModels | UI制御ロジックのテスト |

#### 1.3.3 テスト対象外
- MainWindow.xaml.cs（UI直接操作部分）
- 自動生成コード（*.g.cs, *.g.i.cs）

## 2. Domain Layer テストケース

### 2.1 TrackInfo クラス

**テストクラス名**: `TrackInfoTests`

| テストID | テストケース名 | テスト概要 | 入力 | 期待結果 |
|---------|--------------|-----------|------|---------|
| TI-001 | Constructor_ValidInput_CreatesInstance | 正常なコンストラクタ呼び出し | 駅名="館浜", 番線="1", 軌道回路=["TC_001"] | インスタンス生成成功 |
| TI-002 | Constructor_NullStationName_ThrowsException | 駅名がnullの場合 | 駅名=null | ArgumentNullException |
| TI-003 | Constructor_NullTrackNumber_ThrowsException | 番線がnullの場合 | 番線=null | ArgumentNullException |
| TI-004 | Constructor_NullCircuitIds_ThrowsException | 軌道回路IDsがnullの場合 | 軌道回路=null | ArgumentNullException |
| TI-005 | ContainsCircuit_ExistingCircuit_ReturnsTrue | 存在する軌道回路IDを検索 | 軌道回路="TC_001" | true |
| TI-006 | ContainsCircuit_NonExistingCircuit_ReturnsFalse | 存在しない軌道回路IDを検索 | 軌道回路="TC_999" | false |
| TI-007 | GetKey_ValidData_ReturnsFormattedKey | キー取得 | 駅名="館浜", 番線="1" | "館浜_1" |

### 2.2 GameState クラス

**テストクラス名**: `GameStateTests`

| テストID | テストケース名 | テスト概要 | 入力 | 期待結果 |
|---------|--------------|-----------|------|---------|
| GS-001 | IsPlaying_DrivingScreen_ReturnsTrue | 運転画面時はプレイ中 | Screen=Driving | IsPlaying=true |
| GS-002 | IsPlaying_ConductingScreen_ReturnsTrue | 車掌画面時はプレイ中 | Screen=Conducting | IsPlaying=true |
| GS-003 | IsPlaying_MenuScreen_ReturnsFalse | メニュー画面時は非プレイ中 | Screen=Menu | IsPlaying=false |
| GS-004 | IsAtStation_True_WhenCircuitIdMatches | 駅在線フラグがtrueの場合 | IsAtStation=true | IsAtStation=true |
| GS-005 | IsAtStation_False_WhenNotAtStation | 駅在線フラグがfalseの場合 | IsAtStation=false | IsAtStation=false |

### 2.3 TrainState クラス

**テストクラス名**: `TrainStateTests`

| テストID | テストケース名 | テスト概要 | 入力 | 期待結果 |
|---------|--------------|-----------|------|---------|
| TS-001 | IsStopped_SpeedZero_ReturnsTrue | 速度0のとき停車中 | Speed=0.0 | IsStopped=true |
| TS-002 | IsStopped_SpeedNearZero_ReturnsTrue | 速度0.05のとき停車中 | Speed=0.05 | IsStopped=true |
| TS-003 | IsStopped_SpeedAboveThreshold_ReturnsFalse | 速度0.2のとき走行中 | Speed=0.2 | IsStopped=false |
| TS-004 | IsInbound_EvenTrainNumber_ReturnsTrue | 偶数列車番号は上り | TrainNumber="1234A" | IsInbound()=true |
| TS-005 | IsInbound_OddTrainNumber_ReturnsFalse | 奇数列車番号は下り | TrainNumber="1235A" | IsInbound()=false |
| TS-006 | IsInbound_NullTrainNumber_ReturnsFalse | 列車番号がnullの場合 | TrainNumber=null | IsInbound()=false |
| TS-007 | IsInbound_NonNumericSuffix_ReturnsFalse | 末尾が数字でない場合 | TrainNumber="123A" | IsInbound()=false |
| TS-008 | IsLimitedExpressType_50000Series_ReturnsTrue | 50000系は特急型 | VehicleType="50000" | IsLimitedExpressType()=true |
| TS-009 | IsLimitedExpressType_OtherSeries_ReturnsFalse | その他は通勤型 | VehicleType="E233" | IsLimitedExpressType()=false |
| TS-010 | IsLimitedExpressType_NullVehicleType_ReturnsFalse | 車両形式がnullの場合 | VehicleType=null | IsLimitedExpressType()=false |

### 2.4 SignalInfo クラス

**テストクラス名**: `SignalInfoTests`

| テストID | テストケース名 | テスト概要 | 入力 | 期待結果 |
|---------|--------------|-----------|------|---------|
| SI-001 | IsOpen_ProceedAspect_ReturnsTrue | 進行現示は開通 | Aspect=Proceed | IsOpen=true |
| SI-002 | IsOpen_StopAspect_ReturnsFalse | 停止現示は閉塞 | Aspect=Stop | IsOpen=false |

### 2.5 MelodyState クラス

**テストクラス名**: `MelodyStateTests`

| テストID | テストケース名 | テスト概要 | 入力 | 期待結果 |
|---------|--------------|-----------|------|---------|
| MS-001 | With_UpdateIsPlaying_CreatesNewState | IsPlayingを更新 | isPlaying=true | 新しいインスタンスでIsPlaying=true |
| MS-002 | With_UpdateMultipleProperties_PreservesOthers | 複数プロパティ更新時、他は保持 | isPlaying=true, currentTrack=track1 | 新しいインスタンスで両方更新、他は元のまま |
| MS-003 | With_NoParameters_ReturnsSameValues | パラメータなしで呼び出し | なし | 元の値と同じ新インスタンス |

### 2.6 AutoModeConfig クラス

**テストクラス名**: `AutoModeConfigTests`

| テストID | テストケース名 | テスト概要 | 入力 | 期待結果 |
|---------|--------------|-----------|------|---------|
| AM-001 | GetMarginForVehicle_50000Series_ReturnsSeries50000Margin | 50000系のマージン取得 | TrainState(VehicleType="50000") | Series50000Margin |
| AM-002 | GetMarginForVehicle_OtherSeries_ReturnsStandardMargin | その他車両のマージン取得 | TrainState(VehicleType="E233") | StandardMargin |

### 2.7 AudioProfile クラス

**テストクラス名**: `AudioProfileTests`

| テストID | テストケース名 | テスト概要 | 入力 | 期待結果 |
|---------|--------------|-----------|------|---------|
| AP-001 | Constructor_ValidInput_CreatesInstance | 正常なコンストラクタ呼び出し | 駅名="館浜", 番線="1", メロディー="path.mp3" | インスタンス生成成功 |
| AP-002 | Constructor_NullStationName_ThrowsException | 駅名がnullの場合 | 駅名=null | ArgumentNullException |
| AP-003 | Constructor_NullMelodyPath_ThrowsException | メロディーパスがnullの場合 | メロディー=null | ArgumentNullException |
| AP-004 | GetKey_ValidData_ReturnsFormattedKey | キー取得 | 駅名="館浜", 番線="1" | "館浜_1" |
| AP-005 | GetDoorCloseAnnouncementPath_Inbound_ReturnsUpPath | 上り列車の案内パス取得 | isInbound=true | DoorCloseAnnouncementUpFilePath |
| AP-006 | GetDoorCloseAnnouncementPath_Outbound_ReturnsDownPath | 下り列車の案内パス取得 | isInbound=false | DoorCloseAnnouncementDownFilePath |

## 3. Application Layer テストケース

### 3.1 MelodyControlService クラス

**テストクラス名**: `MelodyControlServiceTests`

| テストID | テストケース名 | テスト概要 | 前提条件 | 入力 | 期待結果 |
|---------|--------------|-----------|---------|------|---------|
| MC-001 | StartMelodyAsync_NotAtStation_DoesNothing | 駅に在線していない場合 | GameState.IsAtStation=false | StartMelodyAsync() | 何もしない、警告ログ出力 |
| MC-002 | StartMelodyAsync_AlreadyPlaying_DoesNothing | 既に再生中の場合 | IsPlaying=true | StartMelodyAsync() | 何もしない、デバッグログ出力 |
| MC-003 | StartMelodyAsync_ValidConditions_StartsPlayback | 正常な条件でメロディー開始 | IsAtStation=true, IsPlaying=false | StartMelodyAsync() | メロディー再生開始、StateChangedイベント発火 |
| MC-004 | StartMelodyAsync_TrackNotFound_LogsWarning | 軌道回路に対応する駅がない場合 | CurrentCircuitId=["TC_999"] | StartMelodyAsync() | 何もしない、警告ログ出力 |
| MC-005 | StopMelodyAsync_NotPlaying_DoesNothing | 再生中でない場合 | IsPlaying=false | StopMelodyAsync() | 何もしない、デバッグログ出力 |
| MC-006 | StopMelodyAsync_ValidConditions_StopsPlayback | 正常な条件でメロディー停止 | IsPlaying=true | StopMelodyAsync() | メロディー停止、ドア閉め案内再生、StateChangedイベント発火 |
| MC-007 | StopMelodyAsync_NoTrackInfo_LogsWarning | 現在のTrackInfoがnullの場合 | CurrentTrack=null | StopMelodyAsync() | 何もしない、警告ログ出力 |
| MC-008 | GetCurrentState_ReturnsCurrentState | 現在状態を取得 | - | GetCurrentState() | 現在のMelodyStateを返す |
| MC-009 | IsUiEnabledAsync_AtStationNotPaused_ReturnsTrue | UI有効条件を満たす場合 | IsAtStation=true, IsPaused=false | IsUiEnabledAsync() | true |
| MC-010 | IsUiEnabledAsync_NotAtStation_ReturnsFalse | 駅に在線していない場合 | IsAtStation=false | IsUiEnabledAsync() | false |
| MC-011 | IsUiEnabledAsync_Paused_ReturnsFalse | 一時停止中の場合 | IsPaused=true | IsUiEnabledAsync() | false |
| MC-012 | OnGameStateChanged_Paused_PausesAudio | 一時停止検知 | IsPaused=true | GameStateChangedイベント | PauseAll()呼び出し |
| MC-013 | OnGameStateChanged_Resumed_ResumesAudio | 一時停止解除検知 | IsPaused=false | GameStateChangedイベント | ResumeAll()呼び出し |
| MC-014 | OnGameStateChanged_LeftStation_StopsPlayback | 駅離脱検知 | IsAtStation=false, IsPlaying=true | GameStateChangedイベント | StopMelody()呼び出し、StateChangedイベント発火 |

### 3.2 AutoModeService クラス

**テストクラス名**: `AutoModeServiceTests`

| テストID | テストケース名 | テスト概要 | 前提条件 | 入力 | 期待結果 |
|---------|--------------|-----------|---------|------|---------|
| AM-101 | StartAsync_SetsEnabled | 自動モード開始 | IsEnabled=false | StartAsync() | IsEnabled=true、Timerが開始 |
| AM-102 | StopAsync_SetsDisabled | 自動モード停止 | IsEnabled=true | StopAsync() | IsEnabled=false、Timerが停止 |
| AM-103 | GetConfig_ReturnsCurrentConfig | 設定取得 | - | GetConfig() | 現在のAutoModeConfigを返す |
| AM-104 | UpdateConfig_UpdatesConfig | 設定更新 | - | UpdateConfig(newConfig) | 新しいConfigが設定される |
| AM-105 | CheckMelodyOnConditions_Condition1_StartsAfter1Sec | 条件1: 到着後1秒でメロディー開始 | 到着時刻から1秒経過 | CheckAndExecuteAsync() | StartMelodyAsync()呼び出し |
| AM-106 | CheckMelodyOnConditions_Condition2_StartsAfterSignalOpen | 条件2: 信号開通0.5秒後にメロディー開始 | 信号開通から0.5秒経過 | CheckAndExecuteAsync() | StartMelodyAsync()呼び出し |
| AM-107 | CheckMelodyOnConditions_Condition3_StartsBeforeDeparture | 条件3: 発車時刻ベースでメロディー開始 | 発車時刻 - メロディー時間 - ドア閉時間 - マージン | CheckAndExecuteAsync() | StartMelodyAsync()呼び出し |
| AM-108 | CheckMelodyOnConditions_NotDriver_DoesNotStart | 運転士モードでない場合 | CrewType=Conductor | CheckAndExecuteAsync() | 何もしない |
| AM-109 | CheckMelodyOnConditions_Paused_DoesNotStart | 一時停止中の場合 | IsPaused=true | CheckAndExecuteAsync() | 何もしない |
| AM-110 | CheckMelodyOnConditions_NotAtStation_ResetsState | 駅に在線していない場合 | IsAtStation=false | CheckAndExecuteAsync() | 状態リセット |
| AM-111 | CheckMelodyOffConditions_BeforeMinDuration_DoesNotStop | ON後1秒未満の場合 | メロディー開始から0.5秒 | CheckAndExecuteAsync() | 何もしない |
| AM-112 | CheckMelodyOffConditions_BeforeMinDoorOpen_DoesNotStop | ドア開後12秒未満の場合 | ドア開から10秒 | CheckAndExecuteAsync() | 何もしない |
| AM-113 | CheckMelodyOffConditions_Condition3_StopsBeforeDeparture | 条件3: 発車時刻ベースでメロディー停止 | 発車時刻 - ドア閉時間 - マージン | CheckAndExecuteAsync() | StopMelodyAsync()呼び出し |
| AM-114 | ResetState_ResetsAllTimestamps | 状態リセット | 各時刻が設定されている | 駅離脱 | 全時刻がnullにリセット |

### 3.3 AudioPlaybackService クラス

**テストクラス名**: `AudioPlaybackServiceTests`

| テストID | テストケース名 | テスト概要 | 前提条件 | 入力 | 期待結果 |
|---------|--------------|-----------|---------|------|---------|
| AB-001 | PlayMelodyAsync_ProfileFound_PlaysAudio | プロファイルが見つかる場合 | AudioProfile存在 | PlayMelodyAsync(track) | PlayLoopAsync()呼び出し |
| AB-002 | PlayMelodyAsync_ProfileNotFound_PlaysDefault | プロファイルがない場合 | AudioProfile=null | PlayMelodyAsync(track) | デフォルトメロディー再生、警告ログ |
| AB-003 | PlayMelodyAsync_FileNotExists_PlaysDefault | ファイルが存在しない場合 | MelodyFilePathが不正 | PlayMelodyAsync(track) | デフォルトメロディー再生、警告ログ |
| AB-004 | PlayMelodyAsync_DefaultNotExists_ThrowsException | デフォルトも存在しない場合 | デフォルトファイルも不正 | PlayMelodyAsync(track) | FileNotFoundException |
| AB-005 | StopMelody_CallsPlayerStop | メロディー停止 | - | StopMelody() | _melodyPlayer.Stop()呼び出し |
| AB-006 | PlayDoorCloseAnnouncementAsync_ProfileFound_PlaysAudio | 案内音声再生 | AudioProfile存在 | PlayDoorCloseAnnouncementAsync(track, true) | PlayOnceAsync()呼び出し |
| AB-007 | PlayDoorCloseAnnouncementAsync_NoPath_LogsWarning | 案内パスが設定されていない場合 | DoorCloseAnnouncementPath=null | PlayDoorCloseAnnouncementAsync(track, true) | 何もしない、警告ログ |
| AB-008 | PlayDoorCloseAnnouncementAsync_FileNotExists_LogsWarning | 案内ファイルが存在しない場合 | ファイルパスが不正 | PlayDoorCloseAnnouncementAsync(track, true) | 何もしない、警告ログ |
| AB-009 | PauseAll_CallsPauseOnBothPlayers | 全音声一時停止 | - | PauseAll() | 両プレーヤーのPause()呼び出し |
| AB-010 | ResumeAll_CallsResumeOnBothPlayers | 全音声再開 | - | ResumeAll() | 両プレーヤーのResume()呼び出し |
| AB-011 | GetMelodyDurationAsync_ValidFile_ReturnsDuration | メロディー時間取得 | FFmpegが35.5秒を返す | GetMelodyDurationAsync(track) | 35.5 |
| AB-012 | GetMelodyDurationAsync_FFmpegFails_ReturnsDefault | FFmpeg失敗時はデフォルト | FFmpegがnullを返す | GetMelodyDurationAsync(track) | 30.0 |

## 4. Infrastructure Layer テストケース

### 4.1 TrackRepository クラス

**テストクラス名**: `TrackRepositoryTests`

| テストID | テストケース名 | テスト概要 | 前提条件 | 入力 | 期待結果 |
|---------|--------------|-----------|---------|------|---------|
| TR-001 | GetAllTracksAsync_ValidCsv_ReturnsAllTracks | 全駅・番線取得 | 正常なCSV | GetAllTracksAsync() | 全TrackInfoのリスト |
| TR-002 | FindTrackByCircuitIdAsync_ExistingCircuit_ReturnsTrack | 軌道回路IDから検索（存在） | CircuitId="TC_001" | FindTrackByCircuitIdAsync("TC_001") | 該当TrackInfo |
| TR-003 | FindTrackByCircuitIdAsync_NonExistingCircuit_ReturnsNull | 軌道回路IDから検索（なし） | CircuitId="TC_999" | FindTrackByCircuitIdAsync("TC_999") | null |
| TR-004 | FindTrackByStationAndNumberAsync_ExistingTrack_ReturnsTrack | 駅名・番線から検索（存在） | 駅名="館浜", 番線="1" | FindTrackByStationAndNumberAsync("館浜", "1") | 該当TrackInfo |
| TR-005 | FindTrackByStationAndNumberAsync_NonExistingTrack_ReturnsNull | 駅名・番線から検索（なし） | 駅名="存在しない駅", 番線="1" | FindTrackByStationAndNumberAsync("存在しない駅", "1") | null |
| TR-006 | LoadCsvAsync_FileNotExists_ThrowsException | CSVファイル未存在 | ファイルなし | LoadCsvAsync() | FileNotFoundException |
| TR-007 | LoadCsvAsync_InvalidRow_SkipsRow | 不正なCSV行をスキップ | カラム数不足行を含む | LoadCsvAsync() | 不正行をスキップ、警告ログ、他の行は読み込み |
| TR-008 | LoadCsvAsync_EmptyStation_SkipsRow | 駅名が空の行をスキップ | 駅名空行を含む | LoadCsvAsync() | スキップ、警告ログ |
| TR-009 | ReloadAsync_ReloadsData | CSV再読み込み | - | ReloadAsync() | キャッシュクリア、再読み込み |

### 4.2 AudioProfileRepository クラス

**テストクラス名**: `AudioProfileRepositoryTests`

| テストID | テストケース名 | テスト概要 | 前提条件 | 入力 | 期待結果 |
|---------|--------------|-----------|---------|------|---------|
| AP-101 | GetAllProfilesAsync_ValidCsv_ReturnsAllProfiles | 全プロファイル取得 | 正常なCSV | GetAllProfilesAsync() | 全AudioProfileのリスト |
| AP-102 | FindProfileAsync_ExistingProfile_ReturnsProfile | プロファイル検索（存在） | 駅名="館浜", 番線="1" | FindProfileAsync("館浜", "1") | 該当AudioProfile |
| AP-103 | FindProfileAsync_NonExistingProfile_ReturnsNull | プロファイル検索（なし） | 駅名="存在しない駅", 番線="1" | FindProfileAsync("存在しない駅", "1") | null |
| AP-104 | LoadCsvAsync_FileNotExists_ThrowsException | CSVファイル未存在 | ファイルなし | LoadCsvAsync() | FileNotFoundException |
| AP-105 | LoadCsvAsync_InvalidRow_SkipsRow | 不正なCSV行をスキップ | カラム数不足行を含む | LoadCsvAsync() | 不正行をスキップ、警告ログ |
| AP-106 | LoadCsvAsync_EmptyMelodyPath_SkipsRow | メロディーパスが空の行をスキップ | メロディーパス空行を含む | LoadCsvAsync() | スキップ、警告ログ |
| AP-107 | LoadCsvAsync_EmptyAnnouncementPath_SetsNull | 案内パスが空の場合nullに変換 | 案内パス空欄 | LoadCsvAsync() | nullに変換、正常読み込み |
| AP-108 | ReloadAsync_ReloadsData | CSV再読み込み | - | ReloadAsync() | キャッシュクリア、再読み込み |

### 4.3 FFmpegService クラス

**テストクラス名**: `FFmpegServiceTests`

| テストID | テストケース名 | テスト概要 | 前提条件 | 入力 | 期待結果 |
|---------|--------------|-----------|---------|------|---------|
| FF-001 | GetAudioDurationAsync_ValidFile_ReturnsDuration | 正常なファイル | 音声ファイル存在 | GetAudioDurationAsync("file.mp3") | 音声ファイルの長さ（秒） |
| FF-002 | GetAudioDurationAsync_FileNotExists_ReturnsNull | ファイル未存在 | ファイルなし | GetAudioDurationAsync("missing.mp3") | null、警告ログ |
| FF-003 | GetAudioDurationAsync_FFmpegNotExists_ReturnsNull | FFmpeg未存在 | FFmpegパスが不正 | GetAudioDurationAsync("file.mp3") | null、エラーログ |
| FF-004 | GetAudioDurationAsync_ParseFailure_ReturnsNull | パース失敗 | FFmpeg出力が不正 | GetAudioDurationAsync("file.mp3") | null、警告ログ |
| FF-005 | GetAudioDurationAsync_Timeout_ReturnsNull | タイムアウト | FFmpegが5秒以上応答しない | GetAudioDurationAsync("file.mp3") | null、エラーログ |

### 4.4 MediaPlayerService クラス

**テストクラス名**: `MediaPlayerServiceTests`

| テストID | テストケース名 | テスト概要 | 前提条件 | 入力 | 期待結果 |
|---------|--------------|-----------|---------|------|---------|
| MP-001 | PlayLoopAsync_ValidFile_StartsPlayback | ループ再生開始 | ファイル存在 | PlayLoopAsync("file.mp3") | IsPlaying=true、ループフラグ=true |
| MP-002 | PlayLoopAsync_FileNotExists_ThrowsException | ファイル未存在 | ファイルなし | PlayLoopAsync("missing.mp3") | FileNotFoundException |
| MP-003 | PlayOnceAsync_ValidFile_StartsPlayback | 1回再生開始 | ファイル存在 | PlayOnceAsync("file.mp3") | IsPlaying=true、ループフラグ=false |
| MP-004 | PlayOnceAsync_FileNotExists_ThrowsException | ファイル未存在 | ファイルなし | PlayOnceAsync("missing.mp3") | FileNotFoundException |
| MP-005 | Stop_StopsPlayback | 停止 | 再生中 | Stop() | IsPlaying=false、ループフラグ=false |
| MP-006 | Pause_PausesPlayback | 一時停止 | 再生中 | Pause() | MediaPlayer.Pause()呼び出し |
| MP-007 | Resume_ResumesPlayback | 再開 | 一時停止中 | Resume() | MediaPlayer.Play()呼び出し |
| MP-008 | OnMediaEnded_LoopEnabled_RestartsPlayback | メディア終了時ループ | ループフラグ=true | OnMediaEnded() | Position=0、Play()呼び出し |
| MP-009 | OnMediaEnded_LoopDisabled_StopsPlayback | メディア終了時停止 | ループフラグ=false | OnMediaEnded() | IsPlaying=false |
| MP-010 | Volume_SetValid_SetsVolume | 音量設定（正常） | - | Volume=0.5 | MediaPlayer.Volume=0.5 |
| MP-011 | Volume_SetAboveMax_ClampsToOne | 音量設定（上限超過） | - | Volume=1.5 | MediaPlayer.Volume=1.0 |
| MP-012 | Volume_SetBelowMin_ClampsToZero | 音量設定（下限超過） | - | Volume=-0.5 | MediaPlayer.Volume=0.0 |

### 4.5 TraincrewGameService クラス

**テストクラス名**: `TraincrewGameServiceTests`

| テストID | テストケース名 | テスト概要 | 前提条件 | 入力 | 期待結果 |
|---------|--------------|-----------|---------|------|---------|
| TG-001 | ConnectAsync_Success_SetsConnected | 接続成功 | WebSocketサーバーが応答 | ConnectAsync() | IsConnected=true、受信ループ開始 |
| TG-002 | ConnectAsync_AlreadyConnected_DoesNothing | 既に接続済み | IsConnected=true | ConnectAsync() | 何もしない、警告ログ |
| TG-003 | ConnectAsync_Failure_ThrowsException | 接続失敗 | WebSocketサーバーが応答しない | ConnectAsync() | 例外スロー、エラーログ |
| TG-004 | DisconnectAsync_Success_SetsDisconnected | 切断成功 | IsConnected=true | DisconnectAsync() | IsConnected=false |
| TG-005 | DisconnectAsync_NotConnected_DoesNothing | 未接続 | IsConnected=false | DisconnectAsync() | 何もしない |
| TG-006 | GetCurrentGameStateAsync_ReturnsGameState | ゲーム状態取得 | DLL呼び出しが成功 | GetCurrentGameStateAsync() | GameStateインスタンス |
| TG-007 | GameStateChanged_FiredOnStateChange | 状態変化時イベント発火 | WebSocketメッセージ受信 | ReceiveLoopAsync() | GameStateChangedイベント発火 |

## 5. Presentation Layer テストケース

### 5.1 MainWindow クラス

**テストクラス名**: `MainWindowTests`

> **注**: MainWindowは直接UIコントロールを扱うため、テストが困難。ViewModelパターン導入により将来的にテスト可能にする。
> 現時点では手動テストで対応。

**手動テストケース**:

| テストID | テストケース名 | テスト概要 | 操作手順 | 期待結果 |
|---------|--------------|-----------|---------|---------|
| MW-001 | OnLoaded_ConnectsToGame | アプリ起動時にゲーム接続 | アプリ起動 | ゲームに接続、エラー表示なし |
| MW-002 | OnLoaded_ConnectionFailed_ShowsError | ゲーム接続失敗時 | ゲーム未起動状態でアプリ起動 | エラーメッセージボックス表示 |
| MW-003 | OnButton_Click_StartsPlayback | ONボタン押下 | 駅在線時にONボタン押下 | メロディー再生開始 |
| MW-004 | OffButton_Click_StopsPlayback | OFFボタン押下 | メロディー再生中にOFFボタン押下 | メロディー停止、案内再生 |
| MW-005 | OnMelodyStateChanged_UpdatesButtonState | メロディー状態変化時 | メロディー開始 | ONボタン無効化、OFFボタン有効化 |
| MW-006 | OnClosing_DisconnectsFromGame | アプリ終了時 | アプリ終了 | ゲーム切断、自動モード停止 |

## 6. テストデータ

### 6.1 stations.csv テストデータ

```csv
駅名,番線,対応軌道回路1,対応軌道回路2,対応軌道回路3
館浜,1,TC_TATEHAMA_01_1,TC_TATEHAMA_01_2,
館浜,2,TC_TATEHAMA_02_1,TC_TATEHAMA_02_2,TC_TATEHAMA_02_3
海浜幕張,1,TC_KAIHINMAKUHARI_01,,
海浜幕張,2,TC_KAIHINMAKUHARI_02,,
```

### 6.2 AudioProfile.csv テストデータ

```csv
駅名,番線,メロディーファイルパス,ドア閉め案内ファイルパス(下り),ドア閉め案内ファイルパス(上り)
館浜,1,.\TestData\Audio\tatehama_1.mp3,.\TestData\Audio\announce1d.mp3,.\TestData\Audio\announce1u.mp3
館浜,2,.\TestData\Audio\tatehama_2.mp3,.\TestData\Audio\announce2d.mp3,.\TestData\Audio\announce2u.mp3
海浜幕張,1,.\TestData\Audio\kaihin.mp3,.\TestData\Audio\announce1d.mp3,.\TestData\Audio\announce1u.mp3
```

### 6.3 音声ファイル テストデータ

- テスト用の短い音声ファイル（1～3秒程度）を用意
- ファイル形式: MP3
- 配置場所: `.\TestData\Audio\`

## 7. モック/スタブ戦略

### 7.1 依存性モック化方針

| インターフェース | モック化方法 | 備考 |
|----------------|-------------|------|
| ITraincrewGameService | Moq | WebSocket通信をモック化 |
| ITrackRepository | Moq | CSV読み込みをモック化 |
| IAudioProfileRepository | Moq | CSV読み込みをモック化 |
| IFFmpegService | Moq | FFmpeg実行をモック化 |
| IAudioPlayerService | Moq | MediaPlayer操作をモック化 |
| IMelodyControlService | Moq | メロディー制御をモック化 |
| IAutoModeService | Moq | 自動モードをモック化 |
| IAudioPlaybackService | Moq | 音声再生をモック化 |

### 7.2 モック例

```csharp
// 例: TraincrewGameServiceのモック
var mockGameService = new Mock<ITraincrewGameService>();
mockGameService.Setup(x => x.GetCurrentGameStateAsync())
    .ReturnsAsync(new GameState
    {
        Screen = GameScreen.Driving,
        IsPaused = false,
        CrewType = CrewType.Driver,
        IsAtStation = true,
        CurrentCircuitId = ["TC_001"]
    });

mockGameService.Setup(x => x.IsConnected).Returns(true);
```

## 8. テスト実行環境

### 8.1 必須ツール
- Visual Studio 2022以降
- .NET 8.0 SDK
- xUnit Test Runner
- Moq NuGet Package

### 8.2 CI/CD統合
- GitHub Actionsでのテスト自動実行
- カバレッジレポート生成（coverlet使用）
- テスト失敗時のビルド失敗

## 9. テストケース優先度

| 優先度 | 定義 | 対象 |
|-------|------|------|
| P0 | クリティカル | 基本機能、データ整合性 |
| P1 | 高 | エラーハンドリング、境界値テスト |
| P2 | 中 | 拡張機能、オプション機能 |
| P3 | 低 | UIフィードバック、ログ出力 |

### 9.1 P0テストケース
- TI-001, TI-002, TI-003, TI-004, TI-005, TI-007
- TS-001, TS-004, TS-005, TS-008
- MC-001, MC-002, MC-003, MC-005, MC-006, MC-014
- AM-101, AM-102, AM-105, AM-106, AM-107, AM-113
- AB-001, AB-002, AB-005, AB-006, AB-009, AB-010
- TR-001, TR-002, TR-004, TR-006
- AP-101, AP-102, AP-104

### 9.2 P1テストケース
- TI-006
- TS-002, TS-003, TS-006, TS-007, TS-009, TS-010
- GS-001, GS-002, GS-003
- MC-004, MC-007, MC-008, MC-009, MC-010, MC-011, MC-012, MC-013
- AM-103, AM-104, AM-108, AM-109, AM-110, AM-111, AM-112, AM-114
- AB-003, AB-004, AB-007, AB-008, AB-011, AB-012
- TR-003, TR-005, TR-007, TR-008, TR-009
- AP-103, AP-105, AP-106, AP-107, AP-108
- FF-001, FF-002, FF-003, FF-004, FF-005

### 9.3 P2テストケース
- MS-001, MS-002, MS-003
- AM-001, AM-002
- AP-001, AP-002, AP-003, AP-004, AP-005, AP-006
- SI-001, SI-002
- MP-001～MP-012
- TG-001～TG-007

## 10. カバレッジ目標

### 10.1 レイヤー別カバレッジ目標

| レイヤー | 目標カバレッジ |
|---------|--------------|
| Domain | 95%以上 |
| Application | 85%以上 |
| Infrastructure | 70%以上 |
| Presentation | 50%以上（将来的にViewModel導入で向上） |

### 10.2 計測方法
- coverletを使用したコードカバレッジ計測
- ReportGeneratorでHTMLレポート生成

## 11. テストコード規約

### 11.1 命名規則
- テストクラス名: `{対象クラス名}Tests`
- テストメソッド名: `{テスト対象メソッド名}_{条件}_{期待結果}`
  - 例: `StartMelodyAsync_NotAtStation_DoesNothing`

### 11.2 Arrange-Act-Assert パターン
```csharp
[Fact]
public async Task StartMelodyAsync_NotAtStation_DoesNothing()
{
    // Arrange
    var mockGameService = new Mock<ITraincrewGameService>();
    mockGameService.Setup(x => x.GetCurrentGameStateAsync())
        .ReturnsAsync(new GameState { IsAtStation = false });

    var service = new MelodyControlService(
        mockGameService.Object,
        mockTrackRepo.Object,
        mockAudioPlayback.Object,
        mockLogger.Object);

    // Act
    await service.StartMelodyAsync();

    // Assert
    mockAudioPlayback.Verify(x => x.PlayMelodyAsync(It.IsAny<TrackInfo>()), Times.Never);
}
```

### 11.3 テストデータビルダー
- 複雑なオブジェクト生成にはビルダーパターンを使用
- 例: `GameStateBuilder`, `TrackInfoBuilder`

## 12. まとめ

本UT設計書では、以下を定義した:

1. **テスト方針**: TDD、DI、カバレッジ目標80%以上
2. **テストケース**: 全レイヤーの主要クラスのテストケースを網羅
3. **モック戦略**: Moqを使った依存性のモック化
4. **テストデータ**: CSVファイル、音声ファイルのテストデータ
5. **実行環境**: xUnit、CI/CD統合
6. **優先度**: P0～P3の優先度分類

各テストケースは、クラス設計書とシーケンス図に基づいて設計されている。
