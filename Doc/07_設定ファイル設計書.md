# 設定ファイル設計書

## 1. 概要

### 1.1 目的
本書は、Traincrew発車メロディー連動システムで使用する全ての設定ファイルの仕様を一元的に定義する。

### 1.2 参照ドキュメント
- 要件定義書.md
- 02_クラス設計書.md
- 03_インターフェース設計書.md
- 06_データモデル設計書.md

### 1.3 設定ファイル一覧

| ファイル名 | 形式 | 優先度 | 配置場所 | 概要 |
|-----------|------|-------|---------|------|
| stations.csv | CSV | 必須 | `.\stations\stations.csv` | 駅・番線と軌道回路の対応マスタ |
| {プロファイル名}.csv | CSV | 必須 | `.\profiles\{プロファイル名}.csv` | 音声ファイルパス設定（複数プロファイル対応） |
| appsettings.json | JSON | 必須 | `.\appsettings.json` | アプリケーション設定 |

## 2. stations.csv（駅・番線マスタ）

### 2.1 概要
駅名・番線番号と、それに対応する軌道回路IDの対応関係を定義する。

### 2.2 ファイル仕様

| 項目 | 仕様 |
|-----|------|
| ファイル名 | stations.csv |
| 文字コード | UTF-8 (BOM無し) |
| 改行コード | CRLF または LF |
| 配置場所 | `.\stations\stations.csv` |
| 区切り文字 | カンマ (,) |
| 必須 | ○ |

### 2.3 フォーマット

#### 2.3.1 ヘッダー行（1行目）

```csv
駅名,番線,対応軌道回路1,対応軌道回路2,対応軌道回路3
```

#### 2.3.2 データ行

```csv
館浜,1,TC_TATEHAMA_01_1,TC_TATEHAMA_01_2,
館浜,2,TC_TATEHAMA_02_1,TC_TATEHAMA_02_2,TC_TATEHAMA_02_3
海浜幕張,1,TC_KAIHINMAKUHARI_01,,
海浜幕張,2,TC_KAIHINMAKUHARI_02,,
稲毛海岸,1,TC_INAGEKAIGAN_01,,
稲毛海岸,2,TC_INAGEKAIGAN_02,,
```

### 2.4 カラム定義

| カラム位置 | カラム名 | 型 | 必須 | 最大長 | 説明 |
|-----------|---------|---|------|-------|------|
| 1 | 駅名 | string | ○ | 50 | 駅の名称（例: "館浜"） |
| 2 | 番線 | string | ○ | 10 | 番線番号（例: "1", "2"） |
| 3 | 対応軌道回路1 | string | ○ | 20 | この番線に対応する軌道回路ID（1つ目） |
| 4 | 対応軌道回路2 | string | × | 20 | この番線に対応する軌道回路ID（2つ目、任意） |
| 5 | 対応軌道回路3 | string | × | 20 | この番線に対応する軌道回路ID（3つ目、任意） |

### 2.5 制約事項

- ヘッダー行は1行目に必須
- **駅名と番線の組み合わせは一意である必要がある**
- **軌道回路IDは重複不可**（異なる番線に同じ軌道回路IDを割り当てることは不可）
- 空行は無視される
- カンマを含む値は引用符で囲む必要がある（例: `"駅名,テスト"`）
- 対応軌道回路1は必須、2・3は任意（空欄可）

### 2.6 バリデーション

| 検証項目 | エラー時の動作 |
|---------|--------------|
| ファイルが存在しない | 例外スロー（アプリ起動失敗） |
| 文字コードが不正 | ログ記録、読み込みスキップ |
| カラム数不足（3列未満） | 該当行をスキップ、警告ログ |
| 駅名が空 | 該当行をスキップ、警告ログ |
| 番線が空 | 該当行をスキップ、警告ログ |
| 対応軌道回路1が空 | 該当行をスキップ、警告ログ |
| 駅名・番線重複 | 後勝ち（上書き）、警告ログ |
| 軌道回路ID重複 | 後勝ち（上書き）、警告ログ |

**注**: stations.csvは全プロファイル共通で使用される。プロファイルごとに異なる駅データを使用することはできない。

### 2.7 サンプルデータ

```csv
駅名,番線,対応軌道回路1,対応軌道回路2,対応軌道回路3
館浜,1,TC_TATEHAMA_01_1,TC_TATEHAMA_01_2,
館浜,2,TC_TATEHAMA_02_1,TC_TATEHAMA_02_2,TC_TATEHAMA_02_3
海浜幕張,1,TC_KAIHINMAKUHARI_01,,
海浜幕張,2,TC_KAIHINMAKUHARI_02,,
稲毛海岸,1,TC_INAGEKAIGAN_01,,
稲毛海岸,2,TC_INAGEKAIGAN_02,,
千葉みなと,1,TC_CHIBAMINATO_01,TC_CHIBAMINATO_01A,
千葉みなと,2,TC_CHIBAMINATO_02,,
```

### 2.8 使用例

```csharp
// 読み込み
var trackRepo = new TrackRepository(config, logger);
var track = await trackRepo.FindTrackByCircuitIdAsync("TC_TATEHAMA_01_1");

// 結果
// track.StationName = "館浜"
// track.TrackNumber = "1"
// track.CircuitIds = ["TC_TATEHAMA_01_1", "TC_TATEHAMA_01_2"]
```

## 3. {プロファイル名}.csv（音声ファイルパス設定）

### 3.1 概要
駅名・番線番号ごとに、使用する発車メロディーとドア閉め案内音声のファイルパスを定義する。複数のプロファイルを用意することで、異なる音声セットを切り替えることができる。

### 3.2 ファイル仕様

| 項目 | 仕様 |
|-----|------|
| ファイル名 | `{プロファイル名}.csv`（例: `default.csv`, `custom.csv`） |
| 文字コード | UTF-8 (BOM無し) |
| 改行コード | CRLF または LF |
| 配置場所 | `.\profiles\{プロファイル名}.csv` |
| 区切り文字 | カンマ (,) |
| 必須 | ○（少なくとも1つのプロファイルが必要） |

### 3.3 プロファイルの切り替え

使用するプロファイルは `appsettings.json` の `CurrentProfileName` で指定する。

```json
{
  "CurrentProfileName": "default"
}
```

この設定により、`.\profiles\default.csv` が読み込まれる。

### 3.4 フォーマット

#### 3.4.1 ヘッダー行（1行目）

```csv
駅名,番線,メロディーファイルパス(下り),メロディーファイルパス(上り),ドア閉め案内ファイルパス(下り),ドア閉め案内ファイルパス(上り)
```

#### 3.4.2 データ行

```csv
館浜,1,.\Audio\default\Melody\tatehama_1_down.mp3,.\Audio\default\Melody\tatehama_1_up.mp3,.\Audio\default\Announcement\announce1d.mp3,.\Audio\default\Announcement\announce1u.mp3
館浜,2,.\Audio\default\Melody\tatehama_2_down.mp3,.\Audio\default\Melody\tatehama_2_up.mp3,.\Audio\default\Announcement\announce2d.mp3,.\Audio\default\Announcement\announce2u.mp3
海浜幕張,1,.\Audio\default\Melody\kaihinmakuhari.mp3,.\Audio\default\Melody\kaihinmakuhari.mp3,.\Audio\default\Announcement\announce1d.mp3,.\Audio\default\Announcement\announce1u.mp3
稲毛海岸,1,.\Audio\default\Melody\inagekaigan.mp3,.\Audio\default\Melody\inagekaigan.mp3,,
```

**注**: メロディーファイルパスが上り・下りで同じ場合は、同じパスを2回記述する（上記の海浜幕張の例を参照）。

### 3.5 カラム定義

| カラム位置 | カラム名 | 型 | 必須 | 説明 |
|-----------|---------|---|------|------|
| 1 | 駅名 | string | ○ | 駅の名称（stations.csvと一致させる） |
| 2 | 番線 | string | ○ | 番線番号（stations.csvと一致させる） |
| 3 | メロディーファイルパス(下り) | string | ○ | 下り列車の発車メロディー音声ファイルパス |
| 4 | メロディーファイルパス(上り) | string | ○ | 上り列車の発車メロディー音声ファイルパス |
| 5 | ドア閉め案内ファイルパス(下り) | string | × | 下り方向のドア閉め案内音声ファイルパス（任意） |
| 6 | ドア閉め案内ファイルパス(上り) | string | × | 上り方向のドア閉め案内音声ファイルパス（任意） |

### 3.6 制約事項

- ヘッダー行は1行目に必須
- **駅名と番線の組み合わせは一意である必要がある**
- メロディーファイルパス(下り)・(上り)は両方必須
- ドア閉め案内ファイルパスは任意（空欄可）
- 空行は無視される
- カンマを含む値は引用符で囲む必要がある
- **絶対パスまたは相対パス（実行フォルダからの相対）で指定可能**
- **同じメロディーファイルを複数の駅・番線で共有可能**
- **上り・下りで同じメロディーを使用する場合は、同じパスを2回記述**

### 3.7 パス指定方法

#### 3.7.1 絶対パス

```csv
館浜,1,C:\Audio\default\Melody\tatehama_1_down.mp3,C:\Audio\default\Melody\tatehama_1_up.mp3,C:\Audio\default\Announcement\announce1d.mp3,C:\Audio\default\Announcement\announce1u.mp3
```

#### 3.7.2 相対パス（推奨）

```csv
館浜,1,.\Audio\default\Melody\tatehama_1_down.mp3,.\Audio\default\Melody\tatehama_1_up.mp3,.\Audio\default\Announcement\announce1d.mp3,.\Audio\default\Announcement\announce1u.mp3
```

相対パスは実行ファイル（.exe）があるフォルダからの相対パスとして解釈される。

### 3.8 バリデーション

| 検証項目 | エラー時の動作 |
|---------|--------------|
| プロファイルファイルが存在しない | 例外スロー（アプリ起動失敗） |
| 文字コードが不正 | ログ記録、読み込みスキップ |
| カラム数不足（4列未満） | 該当行をスキップ、警告ログ |
| 駅名が空 | 該当行をスキップ、警告ログ |
| 番線が空 | 該当行をスキップ、警告ログ |
| メロディーファイルパス(下り)が空 | 該当行をスキップ、警告ログ |
| メロディーファイルパス(上り)が空 | 該当行をスキップ、警告ログ |
| 駅名・番線重複 | 後勝ち（上書き）、警告ログ |

**注**: ファイルパスに指定された音声ファイルが実際に存在するかのチェックは、再生時に行われる（起動時には行わない）。

### 3.9 サンプルデータ

#### 3.9.1 default.csv

```csv
駅名,番線,メロディーファイルパス(下り),メロディーファイルパス(上り),ドア閉め案内ファイルパス(下り),ドア閉め案内ファイルパス(上り)
館浜,1,.\Audio\default\Melody\tatehama_1_down.mp3,.\Audio\default\Melody\tatehama_1_up.mp3,.\Audio\default\Announcement\announce1d.mp3,.\Audio\default\Announcement\announce1u.mp3
館浜,2,.\Audio\default\Melody\tatehama_2.mp3,.\Audio\default\Melody\tatehama_2.mp3,.\Audio\default\Announcement\announce2d.mp3,.\Audio\default\Announcement\announce2u.mp3
海浜幕張,1,.\Audio\default\Melody\kaihinmakuhari.mp3,.\Audio\default\Melody\kaihinmakuhari.mp3,.\Audio\default\Announcement\announce1d.mp3,.\Audio\default\Announcement\announce1u.mp3
海浜幕張,2,.\Audio\default\Melody\kaihinmakuhari.mp3,.\Audio\default\Melody\kaihinmakuhari.mp3,.\Audio\default\Announcement\announce2d.mp3,.\Audio\default\Announcement\announce2u.mp3
稲毛海岸,1,.\Audio\default\Melody\inagekaigan.mp3,.\Audio\default\Melody\inagekaigan.mp3,,
稲毛海岸,2,.\Audio\default\Melody\inagekaigan.mp3,.\Audio\default\Melody\inagekaigan.mp3,,
```

#### 3.9.2 custom.csv（別プロファイルの例）

```csv
駅名,番線,メロディーファイルパス(下り),メロディーファイルパス(上り),ドア閉め案内ファイルパス(下り),ドア閉め案内ファイルパス(上り)
館浜,1,.\Audio\custom\Melody\bell1.mp3,.\Audio\custom\Melody\bell1.mp3,.\Audio\custom\Announcement\announce1d.mp3,.\Audio\custom\Announcement\announce1u.mp3
館浜,2,.\Audio\custom\Melody\bell2.mp3,.\Audio\custom\Melody\bell2.mp3,.\Audio\custom\Announcement\announce2d.mp3,.\Audio\custom\Announcement\announce2u.mp3
```

**注**: 稲毛海岸の例のように、ドア閉め案内ファイルパスは省略可能。その場合、ドア閉め案内は再生されない。

### 3.10 プロファイル使用例

```csharp
// appsettings.jsonで指定されたプロファイルを読み込み
var audioProfileRepo = new AudioProfileRepository(config, logger);
var profile = await audioProfileRepo.FindProfileAsync("館浜", "1");

// 列車が下り（isInbound = false）の場合
// profile.GetMelodyPath(false) => ".\Audio\default\Melody\tatehama_1_down.mp3"

// 列車が上り（isInbound = true）の場合
// profile.GetMelodyPath(true) => ".\Audio\default\Melody\tatehama_1_up.mp3"
```

## 4. appsettings.json（アプリケーション設定）

### 4.1 概要
アプリケーション全体の動作設定を定義する。

### 4.2 ファイル仕様

| 項目 | 仕様 |
|-----|------|
| ファイル名 | appsettings.json |
| 文字コード | UTF-8 (BOM無し) |
| 配置場所 | `.\appsettings.json` |
| 必須 | ○ |

### 4.3 フォーマット

```json
{
  "FFmpegPath": "C:\\ffmpeg\\bin\\ffmpeg.exe",
  "AudioBaseDirectory": ".\\Audio",
  "StationsCsvPath": ".\\stations\\stations.csv",
  "ProfilesDirectory": ".\\profiles",
  "CurrentProfileName": "default",
  "WebSocketPort": 50300,
  "GameStatePollingIntervalMs": 16,
  "DefaultMelodyDownFileName": "default_down.mp3",
  "DefaultMelodyUpFileName": "default_up.mp3",
  "LogDirectory": ".\\Logs",
  "DeveloperMode": false,
  "AutoModeConfig": {
    "IsEnabled": false,
    "DelayAfterArrival": 1.0,
    "DelayAfterSignalOpen": 0.5,
    "MinimumMelodyDuration": 1.0,
    "MinimumDoorOpenDuration": 12.0,
    "DoorCloseAnnouncementDuration": 3.0,
    "StandardMargin": 8.5,
    "Series50000Margin": 16.5
  }
}
```

### 4.4 設定項目定義

#### 4.4.1 基本設定

| 項目 | 型 | デフォルト値 | 説明 |
|-----|---|------------|------|
| FFmpegPath | string | `C:\ffmpeg\bin\ffmpeg.exe` | FFmpeg実行ファイルの絶対パス |
| AudioBaseDirectory | string | `.\Audio` | 音声ファイルのベースディレクトリ |
| StationsCsvPath | string | `.\stations\stations.csv` | stations.csvのパス |
| ProfilesDirectory | string | `.\profiles` | プロファイルCSVファイルを格納するディレクトリ |
| CurrentProfileName | string | `default` | 使用するプロファイル名（拡張子なし） |
| WebSocketPort | int | 50300 | Traincrewゲームサーバーとの通信ポート番号 |
| GameStatePollingIntervalMs | int | 16 | ゲーム状態ポーリング間隔（ミリ秒）※約60FPS相当 |
| DefaultMelodyDownFileName | string | `default_down.mp3` | デフォルトメロディーファイル名（下り） |
| DefaultMelodyUpFileName | string | `default_up.mp3` | デフォルトメロディーファイル名（上り） |
| LogDirectory | string | `.\Logs` | ログ出力ディレクトリ |
| DeveloperMode | bool | false | 開発者モード（デバッグ情報表示） |

#### 4.4.2 自動モード設定

| 項目 | 型 | デフォルト値 | 説明 |
|-----|---|------------|------|
| AutoModeConfig.IsEnabled | bool | false | 自動モードが有効か |
| AutoModeConfig.DelayAfterArrival | double | 1.0 | 到着後の待機時間（秒） |
| AutoModeConfig.DelayAfterSignalOpen | double | 0.5 | 信号開通後の待機時間（秒） |
| AutoModeConfig.MinimumMelodyDuration | double | 1.0 | メロディーON後の最低待機時間（秒） |
| AutoModeConfig.MinimumDoorOpenDuration | double | 12.0 | ドア開後の最低待機時間（秒） |
| AutoModeConfig.DoorCloseAnnouncementDuration | double | 3.0 | ドア閉め案内の再生時間（秒） |
| AutoModeConfig.StandardMargin | double | 8.5 | 通常車両のマージン（秒） |
| AutoModeConfig.Series50000Margin | double | 16.5 | 50000系のマージン（秒） |

### 4.5 計算プロパティ

設定ファイルには含まれないが、`AppConfiguration` クラスで自動計算されるプロパティ:

| プロパティ名 | 計算式 | 説明 |
|------------|--------|------|
| CurrentProfilePath | `Path.Combine(ProfilesDirectory, $"{CurrentProfileName}.csv")` | 現在使用中のプロファイルCSVのパス |

### 4.6 使用例

```csharp
// 読み込み
var config = new ConfigurationBuilder()
    .SetBasePath(Directory.GetCurrentDirectory())
    .AddJsonFile("appsettings.json", optional: false, reloadOnChange: true)
    .Build();

var appConfig = config.Get<AppConfiguration>();

// プロファイルパスを取得
// appConfig.CurrentProfilePath => ".\profiles\default.csv"
```

### 4.7 プロファイルの切り替え方法

appsettings.jsonの `CurrentProfileName` を変更し、アプリケーションを再起動する。

**例**: `default` から `custom` に変更

```json
{
  "CurrentProfileName": "custom"
}
```

これにより、`.\profiles\custom.csv` が読み込まれるようになる。

## 5. 音声ファイル配置

### 5.1 推奨ディレクトリ構造

```
Traincrew_depMelody/
├─ Traincrew_depMelody.exe
├─ appsettings.json
├─ stations/
│  └─ stations.csv
├─ profiles/
│  ├─ default.csv
│  └─ custom.csv
├─ Audio/
│  ├─ default_down.mp3 (デフォルトメロディー 下り)
│  ├─ default_up.mp3 (デフォルトメロディー 上り)
│  ├─ default/
│  │  ├─ Melody/
│  │  │  ├─ tatehama_1_down.mp3
│  │  │  ├─ tatehama_1_up.mp3
│  │  │  ├─ tatehama_2.mp3
│  │  │  ├─ kaihinmakuhari.mp3
│  │  │  └─ ...
│  │  └─ Announcement/
│  │     ├─ announce1d.mp3 (1番線 下り)
│  │     ├─ announce1u.mp3 (1番線 上り)
│  │     ├─ announce2d.mp3 (2番線 下り)
│  │     ├─ announce2u.mp3 (2番線 上り)
│  │     └─ ...
│  └─ custom/
│     ├─ Melody/
│     │  └─ ...
│     └─ Announcement/
│        └─ ...
└─ Logs/
   └─ app-20251022.log
```

### 5.2 音声ファイル仕様

| 項目 | 仕様 |
|-----|------|
| フォーマット | MP3 または WAV |
| サンプルレート | 44.1kHz 推奨 |
| ビットレート | 128kbps 以上（MP3の場合） |
| チャンネル | ステレオ または モノラル |
| 最大ファイルサイズ | 制限なし（ただし、あまり大きいと読み込みに時間がかかる） |

### 5.3 デフォルトメロディー

プロファイルCSVに該当する駅・番線が見つからない場合、以下のデフォルトメロディーが使用される:

**ファイルパス（下り）**: `.\Audio\default_down.mp3`
**ファイルパス（上り）**: `.\Audio\default_up.mp3`

これらのファイルが存在しない場合、アプリケーションはエラーをスローする。

## 6. 設定ファイルの関連図

```
┌─────────────────┐
│ stations.csv    │ ─┐
└─────────────────┘  │
                     │ 参照
┌─────────────────┐  │    ┌──────────────────┐
│ default.csv     │ ─┼───>│ TrackRepository  │
│ (profile)       │  │    └──────────────────┘
└─────────────────┘  │
                     │    ┌──────────────────────────┐
                     ├───>│ AudioProfileRepository   │
                     │    └──────────────────────────┘
                     │
                     │
                     │
┌─────────────────┐  │    ┌──────────────────┐
│appsettings.json │ ─┴───>│ AppConfiguration │
└─────────────────┘       └──────────────────┘
```

## 7. 設定ファイルの読み込みフロー

### 7.1 起動時の読み込み順序

1. **appsettings.json の読み込み**（AppConfiguration の初期化）
2. **stations.csv の読み込み**（TrackRepository）
3. **プロファイルCSV（例: default.csv）の読み込み**（AudioProfileRepository）
   - `CurrentProfileName` で指定されたプロファイルを読み込み
4. バリデーション実行
5. エラーがあればログ出力、致命的エラーの場合は起動中止

### 7.2 読み込みエラー時の挙動

| エラー種別 | 動作 |
|-----------|------|
| appsettings.json が見つからない | 例外スロー → アプリ起動失敗 |
| stations.csv が見つからない | 例外スロー → アプリ起動失敗 |
| プロファイルCSVが見つからない | 例外スロー → アプリ起動失敗 |
| CSVのフォーマットエラー | 該当行をスキップ、警告ログ、起動は継続 |

### 7.3 再読み込み機能

将来的には、以下のような再読み込み機能を実装予定:

```csharp
// CSVを再読み込み
await trackRepository.ReloadAsync();
await audioProfileRepository.ReloadAsync();
```

これにより、アプリケーションを再起動せずに設定変更を反映可能。

## 8. 設定変更の手順

### 8.1 新しい駅・番線を追加する場合

1. **stations.csv に駅・番線情報を追加**

```csv
新駅,1,TC_NEWSTATION_01,,
```

2. **使用中のプロファイルCSV（例: default.csv）に音声ファイルパス情報を追加**

```csv
新駅,1,.\Audio\default\Melody\newstation_down.mp3,.\Audio\default\Melody\newstation_up.mp3,.\Audio\default\Announcement\announce1d.mp3,.\Audio\default\Announcement\announce1u.mp3
```

3. **音声ファイルを配置**

- `.\Audio\default\Melody\newstation_down.mp3` を配置
- `.\Audio\default\Melody\newstation_up.mp3` を配置
- 必要に応じて案内音声も配置

4. **アプリケーションを再起動**（将来は再読み込み機能で対応予定）

### 8.2 音声ファイルを変更する場合

1. **プロファイルCSVのパスを変更**（または音声ファイルを上書き）

```csv
館浜,1,.\Audio\default\Melody\tatehama_1_new_down.mp3,.\Audio\default\Melody\tatehama_1_new_up.mp3,.\Audio\default\Announcement\announce1d.mp3,.\Audio\default\Announcement\announce1u.mp3
```

2. **アプリケーションを再起動**

### 8.3 複数の駅で同じメロディーを使用する場合

プロファイルCSVで同じファイルパスを指定するだけでOK:

```csv
海浜幕張,1,.\Audio\default\Melody\common.mp3,.\Audio\default\Melody\common.mp3,.\Audio\default\Announcement\announce1d.mp3,.\Audio\default\Announcement\announce1u.mp3
稲毛海岸,1,.\Audio\default\Melody\common.mp3,.\Audio\default\Melody\common.mp3,.\Audio\default\Announcement\announce1d.mp3,.\Audio\default\Announcement\announce1u.mp3
```

### 8.4 新しいプロファイルを作成する場合

1. **profiles フォルダに新しいCSVファイルを作成**（例: `custom.csv`）

```csv
駅名,番線,メロディーファイルパス(下り),メロディーファイルパス(上り),ドア閉め案内ファイルパス(下り),ドア閉め案内ファイルパス(上り)
館浜,1,.\Audio\custom\Melody\melody1.mp3,.\Audio\custom\Melody\melody1.mp3,.\Audio\custom\Announcement\ann1d.mp3,.\Audio\custom\Announcement\ann1z.mp3
```

2. **対応する音声ファイルを配置**

- `.\Audio\custom\Melody\melody1.mp3` を配置
- 案内音声も配置

3. **appsettings.json で `CurrentProfileName` を変更**

```json
{
  "CurrentProfileName": "custom"
}
```

4. **アプリケーションを再起動**

## 9. トラブルシューティング

### 9.1 よくあるエラーと対処法

| エラーメッセージ | 原因 | 対処法 |
|----------------|------|--------|
| "appsettings.jsonが見つかりません" | ファイルが存在しない | `.\appsettings.json` を配置 |
| "stations.csvが見つかりません" | ファイルが存在しないか、パスが間違っている | `.\stations\stations.csv` に配置されているか確認 |
| "プロファイルCSVが見つかりません" | 指定されたプロファイルが存在しない | `.\profiles\{プロファイル名}.csv` に配置されているか確認 |
| "不正なCSV行をスキップ" | カラム数が不足している | CSV形式を確認（stations.csvは最低3列、プロファイルCSVは最低4列必要） |
| "音声ファイルが見つかりません" | プロファイルCSVのパスが間違っているか、ファイルが存在しない | ファイルパスを確認、相対パスの場合は実行フォルダからの相対パス |
| "デフォルトメロディーも見つかりません" | default_down.mp3 または default_up.mp3 が存在しない | `.\Audio\default_down.mp3` と `.\Audio\default_up.mp3` を配置 |

### 9.2 文字コードエラー

CSVファイルは **UTF-8 (BOM無し)** で保存する必要がある。

**正しい保存方法**:
- Visual Studio Code: 右下の文字コード表示をクリック → "UTF-8" を選択
- メモ帳: "名前を付けて保存" → エンコード: "UTF-8" を選択

### 9.3 パス区切り文字

Windowsでは、パス区切り文字として `\` と `/` の両方が使用可能。

**推奨**: `\` を使用（例: `.\Audio\Melody\file.mp3`）

**JSON内では**: `\\` とエスケープが必要（例: `".\\Audio\\Melody\\file.mp3"`）

## 10. まとめ

本設定ファイル設計書では、以下を一元的に定義した:

1. **stations.csv**: 駅・番線と軌道回路の対応マスタ
2. **{プロファイル名}.csv**: 音声ファイルパス設定（複数プロファイル対応）
3. **appsettings.json**: アプリケーション設定
4. **音声ファイル配置**: 推奨ディレクトリ構造
5. **設定変更手順**: 新規追加・変更・プロファイル作成の方法
6. **トラブルシューティング**: よくあるエラーと対処法

## 11. 主な変更点（旧仕様からの移行）

旧仕様から以下の変更が行われた:

| 項目 | 旧仕様 | 新仕様 |
|-----|-------|-------|
| 駅マスタファイル名 | `Track.csv` | `stations.csv` |
| 駅マスタ配置場所 | `.\Csv\Track.csv` | `.\stations\stations.csv` |
| プロファイルファイル名 | `AudioProfile.csv`（単一） | `{プロファイル名}.csv`（複数可） |
| プロファイル配置場所 | `.\Csv\AudioProfile.csv` | `.\profiles\{プロファイル名}.csv` |
| メロディーファイルパス | 1列（上下共通） | 2列（上り・下り別） |
| appsettings.json | 将来機能 | 必須 |
| デフォルトメロディー | `default.mp3`（1ファイル） | `default_down.mp3` + `default_up.mp3`（2ファイル） |

これらの設定ファイルは、アプリケーションの動作をユーザーが柔軟にカスタマイズできるように設計されており、複数のプロファイルを切り替えることで、異なる音声セットを簡単に使い分けることができる。
