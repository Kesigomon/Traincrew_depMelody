# 設計書

## 1. システムアーキテクチャ

### 1.1 全体構成

本システムは以下の3層構造で設計されている。

```
┌─────────────────────────────────────┐
│         Presentation Layer          │
│  (Window/MainWindow.xaml, .cs)      │
└─────────────────┬───────────────────┘
                  │
┌─────────────────▼───────────────────┐
│          Service Layer              │
│  - MainService                      │
│  - AutoModeService                  │
│  - MelodyPathService                │
└─────────────────┬───────────────────┘
                  │
┌─────────────────▼───────────────────┐
│        Repository Layer             │
│  - TraincrewRepository              │
│  - AudioPlayerRepository            │
│  - TrackRepository                  │
│  - FFmpegRepository                 │
│  - (KeyboardRepository)             │
│  - (SerialPortRepository)           │
└─────────────────────────────────────┘
```

### 1.2 依存性注入（DI）構成

Microsoft.Extensions.DependencyInjectionを使用してDIコンテナを構成。

**Program.cs** でサービス登録を実施:
- Singleton: すべてのサービス・リポジトリ
- スコープ: MainServiceのTick実行時に新規スコープを作成

## 2. クラス設計

### 2.1 Presentation Layer

#### 2.1.1 MainWindow (Window/MainWindow.xaml.cs)

**責務**: UIとユーザーインタラクションの管理

**主要プロパティ**:
- `_buttonState: ButtonState` - 現在のボタン状態（On/Off/NotChanged）
- `_audioPlayerRepository: IAudioPlayerRepository` - 音声再生リポジトリ
- `_serviceScopeFactory: IServiceScopeFactory` - DIスコープファクトリ
- `_task: Task` - メインループ実行タスク

**主要メソッド**:
- `ButtonPressed(object sender, RoutedEventArgs e)` - ボタン押下時のイベントハンドラ
- `RunAsync(CancellationToken cancellationToken)` - メインループ（16ms周期でTick実行）
- `SetButtonIsEnabled(bool enabled)` - ボタンの有効/無効を設定
- `SetTopMost(bool topMost)` - ウィンドウを最前面に設定
- `GetButtonState()` - 現在のボタン状態を取得
- `GetAudioPlayerRepository()` - AudioPlayerRepositoryを取得

**動作フロー**:
1. コンストラクタで初期化し、RunAsyncをバックグラウンドタスクとして起動
2. RunAsyncは16ms周期でMainService.Tick()を呼び出す
3. 各Tick後、_buttonStateをNotChangedにリセット
4. ウィンドウCloseで_cancellationTokenSourceをキャンセルし、タスクを終了

**XAML構成**:
- 2行グリッド構成
- 1行目: ONボタン（背景:黒、文字:白、フォントサイズ:72）
- 2行目: OFFボタン（背景:赤、文字:白、フォントサイズ:72）
- 初期状態: 両ボタン無効

### 2.2 Service Layer

#### 2.2.1 MainService

**責務**: メインロジックの統括、ゲーム状態管理、メロディー再生制御

**依存コンポーネント**:
- `IMainWindow` - UI制御
- `AutoModeService` - 自動モード処理
- `IAudioPlayerRepository` - 音声再生
- `ITraincrewRepository` - ゲーム状態取得
- `ITrackRepository` - 駅・番線情報取得
- `MelodyPathService` - 音声パス決定

**主要プロパティ**:
- `_previousGameScreen: GameScreen` - 前回のゲーム画面状態
- `_isMelodyPlaying: bool` - メロディー再生中フラグ
- `_isAutoMode: bool` - 自動モードフラグ

**主要メソッド**:
- `Tick()` - 毎フレーム呼び出されるメイン処理
- `TickOnPlaying()` - ゲーム中の毎フレーム処理
- `OnStartGame()` - 乗務開始時の処理
- `OnStopGame()` - 乗務終了時の処理
- `OnPaused()` - 一時停止時の処理
- `OnResumed()` - 一時停止解除時の処理
- `GetButtonState()` - 自動/手動モードに応じたボタン状態取得

**動作フロー**:
```
Tick()
├─ TraincrewRepositoryからゲーム状態取得
├─ ゲーム状態変化検知
│  ├─ ゲーム開始 → OnStartGame()
│  ├─ ゲーム終了 → OnStopGame()
│  ├─ 一時停止 → OnPaused()
│  └─ 一時停止解除 → OnResumed()
└─ MainGame状態の場合 → TickOnPlaying()
   ├─ 軌道回路から駅・番線を特定
   ├─ ホームトラック判定
   ├─ ボタン状態取得（自動/手動）
   ├─ メロディー再生状態との差分判定
   ├─ 状態変化があれば音声パス決定
   └─ AudioPlayerRepositoryで再生
```

**状態遷移ロジック**:
- 乗務開始時: 自動モードフラグを乗務員種別により設定（運転士=自動、車掌=手動）
- ホームトラック上: ボタン有効化（自動モード時は無効）
- ボタン状態変化時のみ音声処理実施
  - NotChanged → 何もしない
  - On && すでに再生中 → 何もしない
  - Off && すでに停止中 → 何もしない
  - それ以外 → 音声処理実施

#### 2.2.2 AutoModeService

**責務**: 自動モードでの発車メロディー制御タイミング決定

**依存コンポーネント**:
- `IFFmpegRepository` - メロディー長さ取得
- `ITraincrewRepository` - ゲーム状態取得
- `ITrackRepository` - 駅・番線情報取得
- `MelodyPathService` - 音声パス決定

**主要プロパティ**:
- `_isPlaying: bool` - 再生中フラグ
- `_arrivingTimeSeconds: double` - 到着時刻（秒）
- `_signalOpenedTimeSeconds: double` - 信号開通時刻（秒）
- `_melodyDuration: double` - メロディー長さ（秒）
- `_doorClosingDuration: double` - ドア閉め案内長さ（秒）
- `_melodyDurationMargin: double` - マージン（車両形式により8.5秒または16.5秒）
- `_previousTrackNumber: int` - 前回の番線
- `_previousAllClose: bool` - 前回のドア閉扉状態
- `_previousIsSignalOpened: bool` - 前回の信号開通状態

**主要メソッド**:
- `GetButtonState()` - 自動モード時のボタン状態を算出
- `Reset()` - 状態をリセット
- `SetMelodyDuration((string, int) trackInfo)` - メロディー長さを取得・設定
- `IsSignalOpened()` - 信号開通判定

**タイミング計算ロジック**:

**ON押下タイミング** = Max(以下3つ):
1. 到着時刻 + 1.0秒
2. 信号開通時刻 + 0.5秒
3. 発車時刻 - メロディー長さ - ドア閉め時間 - マージン

**OFF押下タイミング** = Max(以下3つ):
1. ON押下時刻 + 1.0秒
2. 到着時刻 + 12.0秒（最低ドア開放時間）
3. 発車時刻 - ドア閉め時間 - マージン

**動作フロー**:
```
GetButtonState()
├─ 車両形式によりマージン決定（50000系→16.5秒、その他→8.5秒）
├─ 軌道回路から駅・番線を特定
├─ 状態変化検知
│  ├─ ドア開扉 → 到着時刻記録
│  └─ 信号開通 → 信号開通時刻記録
├─ ホームトラック進入 → SetMelodyDuration()でメロディー長さ取得
├─ 閉扉または信号閉鎖 → ButtonState.Off
├─ タイミング計算
│  ├─ ON押下タイミング算出
│  ├─ OFF押下タイミング算出
│  └─ 現在時刻との比較
└─ ButtonState返却（On/Off）
```

#### 2.2.3 MelodyPathService

**責務**: 駅・番線情報から適切な音声ファイルパスを決定

**依存コンポーネント**:
- `ITraincrewRepository` - 列車種別取得
- `ITrackRepository` - 駅・番線情報取得

**主要メソッド**:
- `GetAudioPath((string, int) trackInfo, bool isMelodyPlaying)` - 音声ファイルパス取得
- `GetMelodyPath(string stationName, int trackNumber, bool isUp)` - メロディーパス取得（static）
- `GetDoorClosingPath(string stationName, int trackNumber, bool isUp)` - ドア閉め案内パス取得（static）

**パス決定ロジック**:

**メロディーファイル**:
- パス: `./sound/{駅名}_{番線}.wav`
- ファイル存在しない場合: `./sound/default.wav`

**ドア閉め案内ファイル**:
- `./sound/doorClosing_{番線}.wav`

**特殊処理**:
- 館浜の場合
  - 1番線 or 2番線で特急の場合: 番線番号
  - それ以外: 番線番号 + 1

### 2.3 Repository Layer

#### 2.3.1 TraincrewRepository

**責務**: Traincrewゲームとの通信、ゲーム状態の取得

**依存ライブラリ**:
- `TrainCrewInput.dll` - ゲーム状態取得用DLL
- `System.Net.WebSockets` - WebSocket通信

**主要プロパティ**:
- `_trainState: TrainState?` - 列車状態
- `_webSocket: ClientWebSocket` - WebSocketクライアント
- `_trackCircuitSet: HashSet<string>` - 在線中の軌道回路セット

**主要メソッド**:
- `Fetch()` - ゲームデータ取得
- `SendMessages()` - WebSocketでデータリクエスト送信
- `ReceiveMessages(string trainNumber)` - WebSocketでデータ受信
- `GetTrainState()` - 列車状態取得
- `GetTrackCircuitSet()` - 軌道回路セット取得
- `GetSignalInfos()` - 信号情報取得
- `GetCrewType()` - 乗務員種別取得
- `GetGameScreen()` - ゲーム画面状態取得

**通信プロトコル**:

**WebSocket接続**:
- エンドポイント: `ws://127.0.0.1:50300/`
- 送信データ形式: JSON
  ```json
  {
    "command": "DataRequest",
    "args": ["tconlyontrain"]
  }
  ```
- 受信データ形式: JSON
  ```json
  {
    "type": "TrainCrewStateData",
    "data": {
      "trackCircuitList": [
        {
          "On": true/false,
          "Lock": true/false,
          "Last": "列車番号",
          "Name": "軌道回路名"
        },
        ...
      ]
    }
  }
  ```

**データ取得フロー**:
```
Fetch()
├─ TrainCrewInput.RequestData(DataRequest.Signal)
├─ TrainCrewInput.GetTrainState()で列車状態取得
├─ WebSocket接続確立
│  └─ 接続失敗時は再生成して終了
├─ MainGame状態かつ接続成功の場合
│  ├─ SendMessages()でデータリクエスト送信
│  └─ ReceiveMessages()で軌道回路情報受信
│     └─ 自列車が在線中の軌道回路のみ抽出
└─ 終了
```

#### 2.3.2 AudioPlayerRepository

**責務**: 音声再生の管理

**使用コンポーネント**:
- `MediaPlayer` (WPF) - 音声再生用（ON用とOFF用の2つ）
- `Dispatcher` - UIスレッドへのマーシャリング

**主要プロパティ**:
- `_playerOn: MediaPlayer` - メロディー再生用
- `_playerOff: MediaPlayer` - ドア閉め案内再生用
- `_dispatcher: Dispatcher` - UIスレッドDispatcher
- `_onCompleteOn: EventHandler?` - メロディー再生完了時のコールバック
- `_onCompleteOff: EventHandler?` - ドア閉め案内再生完了時のコールバック

**主要メソッド**:
- `PlayOn(Uri path, Action? onComplete = null)` - メロディー再生開始
- `PlayOff(Uri path, Action? onComplete = null, TimeSpan? duration = null)` - ドア閉め案内再生
- `Pause()` - 一時停止
- `Resume()` - 再開
- `Reset()` - リセット

**再生動作**:

**PlayOn（メロディー）**:
1. 既存のメロディーを停止
2. 新しい音声ファイルを開く
3. 再生開始
4. MediaEndedイベント: 再生位置を0に戻して再度Play（ループ）

**PlayOff（ドア閉め案内）**:
1. メロディーを停止・クローズ
2. ドア閉め案内の既存再生を停止
3. 新しい音声ファイルを開く
4. 1秒待機後に再生開始（Task.Delay(1000)）
5. MediaEndedイベント: 停止してクローズ（1回のみ再生）

**スレッド安全性**:
- すべての操作をDispatcher.Invoke()でUIスレッドで実行

#### 2.3.3 TrackRepository

**責務**: 駅・番線・軌道回路のマッピング管理

**使用ライブラリ**:
- `CsvHelper` - CSVパース

**主要プロパティ**:
- `_trackCircuitToTrack: Dictionary<HashSet<string>, (string, int)>` - 軌道回路セット→駅名・番線のマッピング

**主要メソッド**:
- `LoadTracksFromCsv()` - CSVから駅・番線情報をロード（コンストラクタで実行）
- `GetTrackByTrackCircuits(HashSet<string> trackCircuits)` - 軌道回路セットから駅名・番線を取得

**CSV読み込みロジック**:
```
LoadTracksFromCsv()
├─ ファイルパス: `Environment.CurrentDirectory\Csv\Track.csv`
├─ CSVファイル読み込み
├─ 各行について
│  ├─ 駅名、番線、対応軌道回路1~3を読み込み
│  ├─ 軌道回路をHashSet<string>に格納
│  │  └─ "なし"または空文字列は除外
│  └─ Dictionaryに追加
└─ 終了
```

**データ構造**:
- Key: 軌道回路のセット（HashSet<string>）
- Value: (駅名, 番線)のタプル
- HashSet.CreateSetComparer()を使用してセット比較

**CSV形式**:
```csv
駅名,番線,対応軌道回路1,対応軌道回路2,対応軌道回路3
館浜,1,TH76_5LAT,なし,なし
駒野,1,TH75_5RAT,なし,なし
...
```

#### 2.3.4 FFmpegRepository

**責務**: FFmpegを使用して音声ファイルの長さを取得

**主要プロパティ**:
- `ffmpegPath: string` - FFmpeg実行ファイルパス（定数: `ffmpeg.exe`）

**主要メソッド**:
- `GetDuration(Uri uri)` - 音声ファイルの長さ（秒）を取得

**処理フロー**:
```
GetDuration(Uri uri)
├─ ProcessStartInfo作成
│  ├─ FileName: ffmpegPath
│  ├─ Arguments: -i "{ファイルパス}"
│  ├─ RedirectStandardError: true
│  └─ CreateNoWindow: true
├─ Process起動
├─ StandardError出力を読み込み
├─ 正規表現でDuration抽出
│  └─ パターン: `Duration: (\d{2}):(\d{2}):(\d{2})\.(\d{2})`
├─ 時:分:秒.ミリ秒をTimeSpanに変換
└─ TotalSecondsを返却
```

**注意点**:
- FFmpegはファイル情報取得のために実行するため、実際には再生しない
- StandardErrorに出力される情報を解析

#### 2.3.5 KeyboardRepository（未実装）

**責務**: キーボード入力の検知と処理

**想定機能**:
- キーバインド設定
- ON/OFFキーの検知
- ButtonState返却

#### 2.3.6 SerialPortRepository（未実装）

**責務**: シリアルポート経由での外部デバイス連携

**想定機能**:
- 物理的な発車メロディースイッチとの連携

## 3. データモデル

### 3.1 列挙型

#### ButtonState (Enum/ButtonState.cs)
```csharp
public enum ButtonState
{
    NotChanged,  // 状態変化なし
    Off,         // OFF押下
    On           // ON押下
}
```

### 3.2 外部ライブラリ定義型（TrainCrewInput.dll）

#### GameScreen
```csharp
public enum GameScreen
{
    NotRunningGame,    // ゲーム未起動
    MainGame,          // ゲーム中
    MainGame_Pause,    // 一時停止中
    // その他...
}
```

#### CrewType
```csharp
public enum CrewType
{
    Driver,   // 運転士
    Conductor // 車掌
}
```

#### TrainState
```csharp
public class TrainState
{
    public TimeSpan NowTime { get; set; }          // 現在時刻
    public bool AllClose { get; set; }             // 全ドア閉扉状態
    public string diaName { get; set; }            // 列車番号
    public string Class { get; set; }              // 列車種別
    public int nowStaIndex { get; set; }           // 現在駅インデックス
    public List<StationInfo> stationList { get; set; } // 駅リスト
    public List<CarState> CarStates { get; set; }  // 車両状態リスト
}
```

#### SignalInfo
```csharp
public class SignalInfo
{
    public string name { get; set; }   // 信号機名
    public string phase { get; set; }  // 現示（"R"=赤、"Y"=黄、"G"=緑など）
}
```

### 3.3 内部データ型

#### TrackCircuitData（TraincrewRepository内部クラス）
```csharp
internal class TrackCircuitData
{
    public bool On { get; set; }      // 在線中か
    public bool Lock { get; set; }    // ロック中か
    public string Last { get; set; }  // 最後に踏んだ列車番号
    public string Name { get; set; }  // 軌道回路名
}
```

## 4. シーケンス図

### 4.1 起動シーケンス

```
Program
├─ CreateHostBuilder()
│  └─ DIコンテナにサービス登録
├─ host.Build()
├─ MainWindow取得
├─ host.StartAsync()
├─ app.Run(mainWindow)
│  └─ MainWindow.RunAsync()起動（バックグラウンド）
└─ （ウィンドウ表示）
```

### 4.2 メインループシーケンス

```
MainWindow.RunAsync()（16ms周期）
│
├─ scope作成
├─ MainService取得
└─ MainService.Tick()
   │
   ├─ TraincrewRepository.Fetch()
   │  ├─ TrainCrewInput.RequestData()
   │  ├─ TrainCrewInput.GetTrainState()
   │  ├─ WebSocket通信で軌道回路取得
   │  └─ 軌道回路セット更新
   │
   ├─ ゲーム状態変化検知
   │  ├─ 乗務開始 → OnStartGame()
   │  ├─ 乗務終了 → OnStopGame()
   │  ├─ 一時停止 → OnPaused()
   │  └─ 一時停止解除 → OnResumed()
   │
   └─ MainGame中 → TickOnPlaying()
      │
      ├─ TrackRepository.GetTrackByTrackCircuits()
      │  └─ 軌道回路から駅名・番線を特定
      │
      ├─ ホームトラック判定
      │  └─ MainWindow.SetButtonIsEnabled()
      │
      ├─ ボタン状態取得
      │  ├─ 自動モード → AutoModeService.GetButtonState()
      │  │  ├─ タイミング計算
      │  │  └─ ButtonState返却
      │  └─ 手動モード → MainWindow.GetButtonState()
      │
      ├─ 状態変化判定
      │  ├─ 変化なし → 処理終了
      │  └─ 変化あり → 音声処理
      │
      ├─ MelodyPathService.GetAudioPath()
      │  └─ 音声ファイルパス決定
      │
      └─ AudioPlayerRepository
         ├─ PlayOn() → メロディー再生
         └─ PlayOff() → ドア閉め案内再生
```

### 4.3 自動モード動作シーケンス

```
AutoModeService.GetButtonState()
│
├─ TrainState取得
│  └─ 車両形式によりマージン決定
│
├─ TrackRepository.GetTrackByTrackCircuits()
│  └─ 駅名・番線取得
│
├─ 状態変化検知
│  ├─ ドア開扉検知 → 到着時刻記録
│  └─ 信号開通検知 → 信号開通時刻記録
│
├─ ホームトラック進入検知
│  └─ FFmpegRepository.GetDuration()
│     ├─ メロディー長さ取得
│     └─ ドア閉め案内長さ取得
│
├─ 条件判定
│  ├─ 閉扉または信号閉鎖 → ButtonState.Off
│  └─ それ以外 → タイミング計算
│
├─ タイミング計算
│  ├─ ON押下タイミング = Max(到着+1秒, 信号開通+0.5秒, 発車-メロディー-ドア閉め-マージン)
│  ├─ OFF押下タイミング = Max(ON+1秒, 到着+12秒, 発車-ドア閉め-マージン)
│  └─ 現在時刻との比較
│
└─ ButtonState返却
```

## 5. 状態遷移図

### 5.1 ゲーム状態遷移

```
NotRunningGame
    │
    ├─ ゲーム開始 → MainGame
    │                  │
    │                  ├─ Pauseキー → MainGame_Pause
    │                  │                   │
    │                  │                   └─ Pauseキー → MainGame
    │                  │
    │                  └─ 乗務終了 → NotRunningGame
    │
    └─ （繰り返し）
```

### 5.2 メロディー再生状態遷移

```
停止中 (_isMelodyPlaying = false)
    │
    ├─ ON押下（自動/手動）→ 再生中 (_isMelodyPlaying = true)
    │                          │
    │                          └─ OFF押下（自動/手動）→ 停止中
    │
    ├─ 一時停止 → Pause状態
    │                │
    │                └─ 一時停止解除 → 元の状態に復帰
    │
    └─ 乗務終了 → Reset → 停止中
```

### 5.3 ボタン有効/無効状態遷移

```
無効
    │
    ├─ MainGame && ホームトラック && !自動モード → 有効
    │                                                │
    │                                                ├─ ホームトラック離脱 → 無効
    │                                                ├─ 自動モード有効化 → 無効
    │                                                └─ 一時停止 → 無効
    │
    └─ 乗務終了 → 無効
```

## 6. エラーハンドリング

### 6.1 例外処理方針

**MainWindow.RunAsync()**:
- try-catchでMainService.Tick()を囲む
- 例外発生時はログ出力して継続
- TaskCanceledExceptionは正常終了として処理

**TraincrewRepository.Fetch()**:
- WebSocket接続失敗時はWebSocketを再生成して終了
- データ取得失敗時は前回のデータを保持

**TrackRepository.LoadTracksFromCsv()**:
- CSVファイル不存在時は例外スロー（起動失敗）

**FFmpegRepository.GetDuration()**:
- 正規表現マッチ失敗時は0.0を返却

### 6.2 ロギング

Microsoft.Extensions.Loggingを使用:
- MainWindow.RunAsync(): エラーログ出力

## 7. パフォーマンス考慮事項

### 7.1 メインループ周期
- 16ms（約60FPS）でTick実行
- 処理時間が16msを超えた場合は次のTick開始が遅延

### 7.2 スコープ管理
- 毎Tick時に新規スコープを作成・破棄
- スコープ内でMainServiceを取得（Singleton実体）

### 7.3 音声ファイル読み込み
- 再生時に都度ファイルを開く（キャッシュなし）
- ファイルI/O負荷を考慮

### 7.4 WebSocket通信
- MainGame状態でのみ通信実施
- 接続失敗時は再試行せず次のTickで再度試行

## 8. セキュリティ考慮事項

### 8.1 ローカル通信のみ
- WebSocket接続先: localhost (127.0.0.1:50300)
- 外部ネットワーク通信なし

### 8.2 ファイルアクセス
- CSVファイル: 読み取り専用
- 音声ファイル: 読み取り専用
- ハードコードされたパスのみアクセス

## 9. 今後の拡張ポイント

### 9.1 設定ファイル化
- 音声ファイルパスの外部設定化
- FFmpegパスの外部設定化
- マージン値の設定化

### 9.2 キーボード操作対応
- KeyboardRepositoryの実装
- キーバインド設定機能

### 9.3 物理スイッチ連携
- SerialPortRepositoryの実装
- Arduinoなどの外部デバイス連携

### 9.4 音声パス管理の柔軟化
- CSV設定による音声ファイルマッピング
- 複数駅での音声共有機能

### 9.5 UIの拡張
- 現在駅・番線の表示
- 自動モードON/OFF切り替えボタン
- 音量調整機能
