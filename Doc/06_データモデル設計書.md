# データモデル設計書

## 1. 概要

### 1.1 目的
本書は、Traincrew発車メロディー連動システムで使用するデータモデルの詳細設計を定義する。

### 1.2 参照ドキュメント
- 要件定義書.md
- 02_クラス設計書.md

### 1.3 データモデル設計方針

| 項目 | 方針 |
|-----|------|
| イミュータビリティ | 基本的にイミュータブル（不変）なモデルを使用 |
| バリデーション | コンストラクタで必須項目をチェック |
| null安全性 | Null許容参照型を有効化し、明示的にnull可否を定義 |
| カプセル化 | プロパティは`init`アクセサで初期化時のみ設定可能 |
| ドメインロジック | モデル内に簡単なビジネスロジックを含める |

## 2. データモデル一覧

| モデル名 | 用途 | イミュータブル | 説明 |
|---------|------|--------------|------|
| TrackInfo | 駅・番線情報 | ○ | 駅と番線の対応関係を保持 |
| GameState | ゲーム状態 | ○ | Traincrewゲームの現在状態 |
| TrainState | 列車状態 | ○ | 列車の運行状態 |
| SignalInfo | 信号情報 | ○ | 信号の現示情報 |
| MelodyState | メロディー状態 | ○ | メロディー再生状態 |
| AutoModeConfig | 自動モード設定 | ○ | 自動モードの設定値 |
| AppConfiguration | アプリ設定 | × | アプリケーション全体の設定（可変） |

## 3. ドメインモデル詳細

### 3.1 TrackInfo（駅・番線情報）

#### 3.1.1 責務
駅と番線の情報、および対応する軌道回路IDを保持する。

#### 3.1.2 クラス図

```
┌─────────────────────────────┐
│      TrackInfo              │
├─────────────────────────────┤
│ + StationName: string       │
│ + TrackNumber: string       │
│ + CircuitIds: List<string>  │
├─────────────────────────────┤
│ + ContainsCircuit(string)   │
│   : bool                    │
│ + GetMelodyFileName()       │
│   : string                  │
│ + GetDoorCloseAnnouncement  │
│   FileName(bool): string    │
└─────────────────────────────┘
```

#### 3.1.3 プロパティ

| プロパティ名 | 型 | 必須 | 説明 | 制約 |
|------------|---|------|------|------|
| StationName | string | ○ | 駅名 | 非null、非空文字列 |
| TrackNumber | string | ○ | 番線番号 | 非null、非空文字列 |
| CircuitIds | List&lt;string&gt; | ○ | 対応軌道回路IDリスト | 非null、要素1個以上 |

#### 3.1.4 メソッド

| メソッド名 | 引数 | 戻り値 | 説明 |
|-----------|------|--------|------|
| ContainsCircuit | circuitId: string | bool | 指定軌道回路IDがこの番線に含まれるか |
| GetMelodyFileName | - | string | メロディーファイル名（例: "館浜_1.mp3"） |
| GetDoorCloseAnnouncementFileName | isInbound: bool | string | ドア閉め案内ファイル名（例: "announcement1u.mp3"） |

#### 3.1.5 サンプルデータ

```csharp
var track = new TrackInfo(
    stationName: "館浜",
    trackNumber: "1",
    circuitIds: new List<string> { "TC_TATEHAMA_01_1", "TC_TATEHAMA_01_2" }
);

// メソッド使用例
bool contains = track.ContainsCircuit("TC_TATEHAMA_01_1"); // true
string melody = track.GetMelodyFileName(); // "館浜_1.mp3"
string announcement = track.GetDoorCloseAnnouncementFileName(true); // "announcement1u.mp3"
```

### 3.2 GameState（ゲーム状態）

#### 3.2.1 責務
Traincrewゲームの現在状態を保持する。

#### 3.2.2 クラス図

```
┌────────────────────────────┐
│       GameState            │
├────────────────────────────┤
│ + Screen: GameScreen       │
│ + IsPaused: bool           │
│ + CrewType: CrewType       │
│ + TrainState: TrainState?  │
│ + SignalInfo: SignalInfo?  │
│ + CurrentCircuitId: string?│
│ + IsAtStation: bool        │
├────────────────────────────┤
│ + IsPlaying: bool (get)    │
└────────────────────────────┘
```

#### 3.2.3 プロパティ

| プロパティ名 | 型 | 必須 | 説明 |
|------------|---|------|------|
| Screen | GameScreen | ○ | ゲーム画面種別 |
| IsPaused | bool | ○ | 一時停止中かどうか |
| CrewType | CrewType | ○ | 乗務員種別 |
| TrainState | TrainState? | × | 列車状態（null可） |
| SignalInfo | SignalInfo? | × | 信号情報（null可） |
| CurrentCircuitId | string? | × | 現在在線中の軌道回路ID |
| IsAtStation | bool | ○ | 駅に在線しているか |

#### 3.2.4 計算プロパティ

| プロパティ名 | 型 | 説明 |
|------------|---|------|
| IsPlaying | bool | プレイ中かどうか（Screen が Driving または Conducting） |

### 3.3 TrainState（列車状態）

#### 3.3.1 責務
列車の運行状態を保持する。

#### 3.3.2 クラス図

```
┌────────────────────────────┐
│      TrainState            │
├────────────────────────────┤
│ + Speed: double            │
│ + IsDoorsOpen: bool        │
│ + TrainNumber: string?     │
│ + VehicleType: string?     │
│ + DepartureTime: DateTime? │
│ + ArrivalTime: DateTime?   │
├────────────────────────────┤
│ + IsStopped: bool (get)    │
│ + IsInbound(): bool        │
│ + Is50000Series(): bool    │
└────────────────────────────┘
```

#### 3.3.3 プロパティ

| プロパティ名 | 型 | 必須 | 説明 |
|------------|---|------|------|
| Speed | double | ○ | 速度 (km/h) |
| IsDoorsOpen | bool | ○ | ドアが開いているか |
| TrainNumber | string? | × | 列車番号（例: "1234M"） |
| VehicleType | string? | × | 車両形式（例: "50000"） |
| DepartureTime | DateTime? | × | 発車時刻 |
| ArrivalTime | DateTime? | × | 到着時刻 |

#### 3.3.4 計算プロパティ・メソッド

| 名前 | 型 | 説明 |
|-----|---|------|
| IsStopped | bool | 停車中かどうか（Speed < 0.1） |
| IsInbound() | bool | 上り列車かどうか（列車番号末尾で判定） |
| Is50000Series() | bool | 50000系車両かどうか |

#### 3.3.5 上り/下り判定ロジック

```csharp
public bool IsInbound()
{
    if (string.IsNullOrEmpty(TrainNumber)) return false;

    // 列車番号の末尾が数字の場合、奇数なら上り、偶数なら下り
    char lastChar = TrainNumber[^1];
    if (char.IsDigit(lastChar))
    {
        return int.Parse(lastChar.ToString()) % 2 == 1;
    }
    // 末尾が 'T' なら上り、'M' なら下り
    return lastChar == 'T';
}
```

### 3.4 SignalInfo（信号情報）

#### 3.4.1 責務
信号の現示情報を保持する。

#### 3.4.2 クラス図

```
┌────────────────────────────┐
│      SignalInfo            │
├────────────────────────────┤
│ + Aspect: SignalAspect     │
│ + OpenedAt: DateTime?      │
├────────────────────────────┤
│ + IsOpen: bool (get)       │
└────────────────────────────┘
```

#### 3.4.3 プロパティ

| プロパティ名 | 型 | 必須 | 説明 |
|------------|---|------|------|
| Aspect | SignalAspect | ○ | 信号現示 |
| OpenedAt | DateTime? | × | 信号が開通した時刻 |

#### 3.4.4 計算プロパティ

| プロパティ名 | 型 | 説明 |
|------------|---|------|
| IsOpen | bool | 信号が開通しているか（Aspect != Stop） |

### 3.5 MelodyState（メロディー状態）

#### 3.5.1 責務
メロディー再生の状態を保持する。

#### 3.5.2 クラス図

```
┌─────────────────────────────────┐
│       MelodyState               │
├─────────────────────────────────┤
│ + IsPlaying: bool               │
│ + CurrentMelodyPath: string?    │
│ + CurrentTrack: TrackInfo?      │
│ + StartedAt: DateTime?          │
│ + DoorCloseAnnouncement         │
│   Played: bool                  │
├─────────────────────────────────┤
│ + With(...): MelodyState        │
└─────────────────────────────────┘
```

#### 3.5.3 プロパティ

| プロパティ名 | 型 | 必須 | 説明 |
|------------|---|------|------|
| IsPlaying | bool | ○ | 再生中かどうか |
| CurrentMelodyPath | string? | × | 現在再生中のメロディーファイルパス |
| CurrentTrack | TrackInfo? | × | 現在の駅・番線情報 |
| StartedAt | DateTime? | × | メロディー開始時刻 |
| DoorCloseAnnouncementPlayed | bool | ○ | ドア閉め案内を再生済みか |

#### 3.5.4 メソッド

| メソッド名 | 説明 |
|-----------|------|
| With(...) | イミュータブル更新（指定プロパティのみ変更した新しいインスタンスを返す） |

#### 3.5.5 With メソッド使用例

```csharp
var currentState = new MelodyState
{
    IsPlaying = false,
    DoorCloseAnnouncementPlayed = false
};

// IsPlayingだけ変更した新しいインスタンスを生成
var newState = currentState.With(isPlaying: true, startedAt: DateTime.Now);
```

### 3.6 AutoModeConfig（自動モード設定）

#### 3.6.1 責務
自動モードの設定値を保持する。

#### 3.6.2 クラス図

```
┌────────────────────────────────┐
│     AutoModeConfig             │
├────────────────────────────────┤
│ + IsEnabled: bool              │
│ + DelayAfterArrival: double    │
│ + DelayAfterSignalOpen: double │
│ + MinimumMelodyDuration: double│
│ + MinimumDoorOpenDuration      │
│   : double                     │
│ + DoorCloseAnnouncement        │
│   Duration: double             │
│ + StandardMargin: double       │
│ + Series50000Margin: double    │
├────────────────────────────────┤
│ + GetMarginForVehicle          │
│   (TrainState): double         │
└────────────────────────────────┘
```

#### 3.6.3 プロパティ

| プロパティ名 | 型 | 必須 | デフォルト値 | 説明 |
|------------|---|------|------------|------|
| IsEnabled | bool | ○ | false | 自動モードが有効か |
| DelayAfterArrival | double | ○ | 1.0 | 到着後の待機時間（秒） |
| DelayAfterSignalOpen | double | ○ | 0.5 | 信号開通後の待機時間（秒） |
| MinimumMelodyDuration | double | ○ | 1.0 | メロディーON後の最低待機時間（秒） |
| MinimumDoorOpenDuration | double | ○ | 12.0 | ドア開後の最低待機時間（秒） |
| DoorCloseAnnouncementDuration | double | ○ | 3.0 | ドア閉め案内の再生時間（秒） |
| StandardMargin | double | ○ | 8.5 | 通常車両のマージン（秒） |
| Series50000Margin | double | ○ | 16.5 | 50000系のマージン（秒） |

#### 3.6.4 メソッド

| メソッド名 | 引数 | 戻り値 | 説明 |
|-----------|------|--------|------|
| GetMarginForVehicle | trainState: TrainState | double | 車両形式に応じたマージンを返す |

### 3.7 AppConfiguration（アプリ設定）

#### 3.7.1 責務
アプリケーション全体の設定を保持する（可変）。

#### 3.7.2 クラス図

```
┌────────────────────────────────┐
│    AppConfiguration            │
├────────────────────────────────┤
│ + FFmpegPath: string           │
│ + AudioBaseDirectory: string   │
│ + TrackCsvPath: string         │
│ + WebSocketPort: int           │
│ + GameStatePollingInterval     │
│   Ms: int                      │
│ + DefaultMelodyFileName        │
│   : string                     │
│ + LogDirectory: string         │
│ + DeveloperMode: bool          │
├────────────────────────────────┤
│ + MelodyDirectory: string (get)│
│ + AnnouncementDirectory        │
│   : string (get)               │
└────────────────────────────────┘
```

#### 3.7.3 プロパティ

| プロパティ名 | 型 | デフォルト値 | 説明 |
|------------|---|------------|------|
| FFmpegPath | string | `C:\ffmpeg\bin\ffmpeg.exe` | FFmpeg実行ファイルパス |
| AudioBaseDirectory | string | `.\Audio` | 音声ファイルベースディレクトリ |
| TrackCsvPath | string | `.\Csv\Track.csv` | Track.csvのパス |
| WebSocketPort | int | 50300 | WebSocketポート番号 |
| GameStatePollingIntervalMs | int | 16 | ゲーム状態ポーリング間隔（ミリ秒） |
| DefaultMelodyFileName | string | `default.mp3` | デフォルトメロディーファイル名 |
| LogDirectory | string | `.\Logs` | ログ出力ディレクトリ |
| DeveloperMode | bool | false | 開発者モード（デバッグ情報表示） |

#### 3.7.4 計算プロパティ

| プロパティ名 | 型 | 説明 |
|------------|---|------|
| MelodyDirectory | string | メロディーフォルダパス（AudioBaseDirectory + "Melody"） |
| AnnouncementDirectory | string | 案内音声フォルダパス（AudioBaseDirectory + "Announcement"） |

## 4. 列挙型（Enum）定義

### 4.1 GameScreen（ゲーム画面種別）

```csharp
public enum GameScreen
{
    Menu,        // メニュー画面
    Driving,     // 運転士モード
    Conducting,  // 車掌モード
    Other        // その他
}
```

### 4.2 CrewType（乗務員種別）

```csharp
public enum CrewType
{
    None,       // 非乗務
    Driver,     // 運転士
    Conductor   // 車掌
}
```

### 4.3 SignalAspect（信号現示）

```csharp
public enum SignalAspect
{
    Stop,           // 停止（赤）
    Caution,        // 注意（黄）
    SlowClear,      // 減速（黄/緑）
    Clear,          // 進行（緑）
    HighSpeedClear  // 高速進行（緑/緑）
}
```

## 5. データ関連図

### 5.1 モデル間の関連

```
┌─────────────┐
│  GameState  │
└──────┬──────┘
       │ contains
       ├─────────────┐
       │             │
       ▼             ▼
┌─────────────┐ ┌─────────────┐
│ TrainState  │ │ SignalInfo  │
└─────────────┘ └─────────────┘

┌──────────────┐     references     ┌─────────────┐
│ MelodyState  │───────────────────>│  TrackInfo  │
└──────────────┘                    └─────────────┘

┌──────────────────┐
│ AutoModeConfig   │
└──────────────────┘

┌──────────────────┐
│ AppConfiguration │
└──────────────────┘
```

### 5.2 データフロー図

```
TrackRepository (Track.csv)
       │
       │ provides
       ▼
   TrackInfo ──┐
       ▲       │
       │       │ used by
       │       ▼
       │   MelodyControl
       │   Service
       │       │
       │       │ updates
       └───────┤
               ▼
          MelodyState


TraincrewGameService
       │
       │ provides
       ▼
   GameState
       │
       │ used by
       ▼
   AutoModeService
```

## 6. バリデーション規則

### 6.1 TrackInfo

| 項目 | ルール |
|-----|--------|
| StationName | 非null、非空、最大50文字 |
| TrackNumber | 非null、非空、最大10文字 |
| CircuitIds | 非null、要素1個以上、各要素は非null・非空 |

### 6.2 TrainState

| 項目 | ルール |
|-----|--------|
| Speed | 0以上 |
| TrainNumber | nullまたは非空文字列 |
| VehicleType | nullまたは非空文字列 |
| DepartureTime | nullまたは妥当な日時 |
| ArrivalTime | nullまたは妥当な日時 |

### 6.3 AutoModeConfig

| 項目 | ルール |
|-----|--------|
| DelayAfterArrival | 0以上 |
| DelayAfterSignalOpen | 0以上 |
| MinimumMelodyDuration | 0以上 |
| MinimumDoorOpenDuration | 0以上 |
| DoorCloseAnnouncementDuration | 0以上 |
| StandardMargin | 0以上 |
| Series50000Margin | 0以上 |

## 7. データ永続化

### 7.1 永続化対象

| データ | 永続化方法 | ファイル形式 |
|-------|----------|------------|
| TrackInfo | CSV | Track.csv |
| AppConfiguration | 将来的にJSON | appsettings.json（将来） |
| AutoModeConfig | 将来的にJSON | appsettings.json（将来） |

### 7.2 永続化しないデータ

以下はランタイム状態であり、永続化しない：
- GameState
- TrainState
- SignalInfo
- MelodyState

## 8. データ変換

### 8.1 CSV → TrackInfo

```csharp
// CSV行: "館浜,1,TC_001,TC_002,"
// ↓
var track = new TrackInfo(
    stationName: "館浜",
    trackNumber: "1",
    circuitIds: new List<string> { "TC_001", "TC_002" }
);
```

### 8.2 DLL戻り値 → GameState

```csharp
// DLL関数呼び出し結果を組み立て
var gameState = new GameState
{
    Screen = (GameScreen)GetGameScreen(),
    IsPaused = IsPaused(),
    CrewType = (CrewType)GetCrewType(),
    TrainState = new TrainState
    {
        Speed = GetTrainSpeed(),
        IsDoorsOpen = IsDoorsOpen(),
        TrainNumber = Marshal.PtrToStringAnsi(GetTrainNumber()),
        // ...
    },
    // ...
};
```

### 8.3 JSON → AppConfiguration（将来）

```json
{
  "FFmpegPath": "C:\\ffmpeg\\bin\\ffmpeg.exe",
  "AudioBaseDirectory": ".\\Audio",
  "WebSocketPort": 50300
}
```

```csharp
var config = JsonSerializer.Deserialize<AppConfiguration>(json);
```

## 9. メモリ管理

### 9.1 イミュータブルモデルのメリット

- スレッドセーフ（複数スレッドから安全にアクセス可能）
- 状態管理が容易（予期しない変更が発生しない）
- デバッグしやすい

### 9.2 With パターンの使用

状態更新は `With` メソッドで新しいインスタンスを生成。

```csharp
// 古い状態
var oldState = new MelodyState { IsPlaying = false };

// 新しい状態（IsPlayingだけ変更）
var newState = oldState.With(isPlaying: true);

// oldStateは変更されない（イミュータブル）
```

## 10. まとめ

本データモデル設計書では、以下を定義した：

1. **7つのコアモデル**: TrackInfo, GameState, TrainState, SignalInfo, MelodyState, AutoModeConfig, AppConfiguration
2. **3つの列挙型**: GameScreen, CrewType, SignalAspect
3. **イミュータブル設計**: 状態の不変性を保証
4. **バリデーション規則**: データ整合性の確保
5. **データフロー**: モデル間の関連と依存関係

これらのモデルは、ドメイン駆動設計（DDD）の原則に従い、ビジネスロジックとデータ構造を明確に表現している。
