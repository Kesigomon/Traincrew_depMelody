# シーケンス図

## 1. 概要

### 1.1 目的
本書は、Traincrew発車メロディー連動システムの主要なユースケースにおける処理フローをシーケンス図で表現する。

### 1.2 参照ドキュメント
- 要件定義書.md
- 01_システムアーキテクチャ設計書.md
- 02_クラス設計書.md
- 03_インターフェース設計書.md

### 1.3 シーケンス図一覧

| ID | シーケンス名 | 概要 |
|----|------------|------|
| SEQ-001 | アプリケーション起動 | アプリ起動からゲーム接続まで |
| SEQ-002 | 手動モード - メロディー開始 | ONボタン押下時の処理 |
| SEQ-003 | 手動モード - メロディー停止 | OFFボタン押下時の処理 |
| SEQ-004 | 自動モード - メロディー開始 | 自動モードでのメロディー開始 |
| SEQ-005 | 自動モード - メロディー停止 | 自動モードでのメロディー停止 |
| SEQ-006 | ゲーム一時停止検知 | 一時停止時の音声制御 |
| SEQ-007 | 駅からの離脱検知 | 駅を離れた時の処理 |

## 2. SEQ-001: アプリケーション起動

### 2.1 概要
アプリケーションの起動からゲームサーバーへの接続完了まで。

### 2.2 シーケンス図

```
User           App         MainWindow    GameService    TrackRepo    DI Container
 |              |              |              |             |              |
 |--起動------->|              |              |             |              |
 |              |--OnStartup-->|              |             |              |
 |              |              |              |             |              |
 |              |--ConfigureServices------------------------------->[作成]
 |              |              |              |             |              |
 |              |<-ServiceProvider----------------------------------|
 |              |              |              |             |              |
 |              |--GetRequiredService<MainWindow>----------------->|
 |              |              |              |             |              |
 |              |<-MainWindow instance-----------------------------|
 |              |              |              |             |              |
 |              |--Show()----->|              |             |              |
 |              |              |--OnLoaded--->|             |              |
 |              |              |              |             |              |
 |              |              |--ConnectAsync()----------->|              |
 |              |              |              |             |              |
 |              |              |              |--WebSocket接続             |
 |              |              |              |  (localhost:50300)         |
 |              |              |              |             |              |
 |              |              |              |--受信ループ起動            |
 |              |              |              |             |              |
 |              |              |<-接続成功---|             |              |
 |              |              |              |             |              |
 |              |              |--ReloadAsync()------------>|              |
 |              |              |              |             |              |
 |              |              |              |             |--Track.csv読込
 |              |              |              |             |              |
 |              |              |              |<-読込完了---|              |
 |              |              |              |             |              |
 |<-ウィンドウ表示--------------|              |             |              |
 |              |              |              |             |              |
```

### 2.3 処理ステップ

1. ユーザーがアプリを起動
2. `App.OnStartup()` が呼ばれる
3. DIコンテナを構成（`ConfigureServices()`）
4. `MainWindow` をDIコンテナから取得
5. `MainWindow.Show()` でウィンドウ表示
6. `MainWindow.OnLoaded()` イベント
7. `TraincrewGameService.ConnectAsync()` でWebSocket接続
8. `TrackRepository.ReloadAsync()` でTrack.csv読み込み
9. アプリケーション起動完了

## 3. SEQ-002: 手動モード - メロディー開始

### 3.1 概要
ユーザーがONボタンを押してメロディーを開始する処理。

### 3.2 シーケンス図

```
User    MainWindow  MelodyControl  GameService  TrackRepo  AudioPlayback  MediaPlayer
 |          |            |              |            |            |            |
 |--ONクリック->          |              |            |            |            |
 |          |            |              |            |            |            |
 |          |--OnButton_Click()         |            |            |            |
 |          |            |              |            |            |            |
 |          |--StartMelodyAsync()------>|            |            |            |
 |          |            |              |            |            |            |
 |          |            |--状態チェック(再生中?)   |            |            |
 |          |            |(既に再生中ならreturn)    |            |            |
 |          |            |              |            |            |            |
 |          |            |--GetCurrentGameStateAsync()           |            |
 |          |            |              |            |            |            |
 |          |            |              |--DLL呼出し(GetGameScreen等)          |
 |          |            |              |            |            |            |
 |          |            |              |--WebSocketから軌道回路取得           |
 |          |            |              |            |            |            |
 |          |            |<-GameState---|            |            |            |
 |          |            |              |            |            |            |
 |          |            |--駅在線チェック         |            |            |
 |          |            |(在線していなければreturn)|            |            |
 |          |            |              |            |            |            |
 |          |            |--FindTrackByCircuitIdAsync()          |            |
 |          |            |              |            |            |            |
 |          |            |              |            |--Track検索|            |
 |          |            |              |            |            |            |
 |          |            |              |<-TrackInfo|            |            |
 |          |            |              |            |            |            |
 |          |            |--PlayMelodyAsync(track)-------------->|            |
 |          |            |              |            |            |            |
 |          |            |              |            |            |--メロディーパス取得
 |          |            |              |            |            |            |
 |          |            |              |            |            |--ファイル存在確認
 |          |            |              |            |            |            |
 |          |            |              |            |            |--PlayLoopAsync()
 |          |            |              |            |            |            |
 |          |            |              |            |            |            |--Open(uri)
 |          |            |              |            |            |            |
 |          |            |              |            |            |            |--Play()
 |          |            |              |            |            |            |
 |          |            |              |            |            |<-再生開始--|
 |          |            |              |            |            |            |
 |          |            |<-再生完了-------------------------|    |            |
 |          |            |              |            |            |            |
 |          |            |--状態更新(IsPlaying=true)            |            |
 |          |            |              |            |            |            |
 |          |            |--StateChanged イベント発火           |            |
 |          |            |              |            |            |            |
 |          |<-イベント通知-|            |            |            |            |
 |          |              |            |            |            |            |
 |          |--ボタン状態更新(ON無効、OFF有効)        |            |            |
 |          |              |            |            |            |            |
 |<-ボタン更新表示-|        |            |            |            |            |
 |          |              |            |            |            |            |
```

### 3.3 処理ステップ

1. ユーザーがONボタンをクリック
2. `MainWindow.OnButton_Click()` が呼ばれる
3. `MelodyControlService.StartMelodyAsync()` を呼び出し
4. 既に再生中かチェック（再生中ならreturn）
5. `TraincrewGameService.GetCurrentGameStateAsync()` でゲーム状態取得
6. 駅に在線しているかチェック（在線していなければreturn）
7. `TrackRepository.FindTrackByCircuitIdAsync()` で駅・番線特定
8. `AudioPlaybackService.PlayMelodyAsync()` でメロディー再生
9. メロディーファイルパス取得、存在確認
10. `MediaPlayerService.PlayLoopAsync()` でループ再生開始
11. 状態更新（IsPlaying=true）
12. StateChangedイベント発火
13. MainWindowがイベントを受け取り、ボタン状態更新

## 4. SEQ-003: 手動モード - メロディー停止

### 4.1 概要
ユーザーがOFFボタンを押してメロディーを停止し、ドア閉め案内を再生する処理。

### 4.2 シーケンス図

```
User    MainWindow  MelodyControl  GameService  AudioPlayback  MediaPlayer
 |          |            |              |            |            |
 |--OFFクリック->         |              |            |            |
 |          |            |              |            |            |
 |          |--OffButton_Click()        |            |            |
 |          |            |              |            |            |
 |          |--StopMelodyAsync()------->|            |            |
 |          |            |              |            |            |
 |          |            |--状態チェック(再生中?)   |            |
 |          |            |(再生中でなければreturn)  |            |
 |          |            |              |            |            |
 |          |            |--StopMelody()------------>|            |
 |          |            |              |            |            |
 |          |            |              |            |--Stop()--->|
 |          |            |              |            |            |
 |          |            |              |            |            |--Stop()
 |          |            |              |            |            |
 |          |            |              |            |<-停止完了--|
 |          |            |              |            |            |
 |          |            |<-停止完了-----------------|            |
 |          |            |              |            |            |
 |          |            |--状態更新(IsPlaying=false)            |
 |          |            |              |            |            |
 |          |            |--StateChanged イベント発火           |
 |          |            |              |            |            |
 |          |<-イベント通知-|            |            |            |
 |          |              |            |            |            |
 |          |--ボタン状態更新(ON有効、OFF無効)        |            |
 |          |              |            |            |            |
 |          |            |--Task.Delay(1000)        |            |
 |          |            |  (1秒待機)   |            |            |
 |          |            |              |            |            |
 |          |            |--GetCurrentGameStateAsync()           |
 |          |            |              |            |            |
 |          |            |<-GameState---|            |            |
 |          |            |              |            |            |
 |          |            |--上り/下り判定(TrainState.IsInbound()) |
 |          |            |              |            |            |
 |          |            |--PlayDoorCloseAnnouncementAsync()---->|
 |          |            |              |            |            |
 |          |            |              |            |--案内パス取得
 |          |            |              |            |            |
 |          |            |              |            |--PlayOnceAsync()
 |          |            |              |            |            |
 |          |            |              |            |            |--Open(uri)
 |          |            |              |            |            |
 |          |            |              |            |            |--Play()
 |          |            |              |            |            |
 |          |            |              |            |<-再生開始--|
 |          |            |              |            |            |
 |          |            |<-再生完了-----------------|            |
 |          |            |              |            |            |
 |          |            |--状態更新(DoorCloseAnnouncementPlayed=true)
 |          |            |              |            |            |
 |          |            |--StateChanged イベント発火           |
 |          |            |              |            |            |
```

### 4.3 処理ステップ

1. ユーザーがOFFボタンをクリック
2. `MainWindow.OffButton_Click()` が呼ばれる
3. `MelodyControlService.StopMelodyAsync()` を呼び出し
4. 再生中かチェック（再生中でなければreturn）
5. `AudioPlaybackService.StopMelody()` でメロディー停止
6. 状態更新（IsPlaying=false）
7. StateChangedイベント発火、ボタン状態更新
8. 1秒待機（`Task.Delay(1000)`）
9. ゲーム状態取得、上り/下り判定
10. `AudioPlaybackService.PlayDoorCloseAnnouncementAsync()` で案内再生
11. 案内ファイルを1回再生
12. 状態更新（DoorCloseAnnouncementPlayed=true）

## 5. SEQ-004: 自動モード - メロディー開始

### 5.1 概要
自動モードで条件を満たした時にメロディーを自動開始する処理。

### 5.2 シーケンス図

```
Timer    AutoMode   MelodyControl  GameService  TrackRepo  AudioPlayback  FFmpeg
 |          |            |              |            |            |          |
 |--16ms周期|            |              |            |            |          |
 |          |            |              |            |            |          |
 |--Tick--->|            |              |            |            |          |
 |          |            |              |            |            |          |
 |          |--CheckAndExecuteAsync()   |            |            |          |
 |          |            |              |            |            |          |
 |          |--自動モード有効チェック   |            |            |          |
 |          |            |              |            |            |          |
 |          |--GetCurrentGameStateAsync()           |            |          |
 |          |            |              |            |            |          |
 |          |<-GameState|              |            |            |          |
 |          |            |              |            |            |          |
 |          |--運転士モードチェック     |            |            |          |
 |          |--一時停止チェック         |            |            |          |
 |          |--在線チェック             |            |            |          |
 |          |            |              |            |            |          |
 |          |--到着時刻記録             |            |            |          |
 |          |--信号開通時刻記録         |            |            |          |
 |          |--ドア開時刻記録           |            |            |          |
 |          |            |              |            |            |          |
 |          |--CheckMelodyOnConditions()|            |            |          |
 |          |            |              |            |            |          |
 |          |--条件1チェック: 到着後1秒 |            |            |          |
 |          |--条件2チェック: 信号開通0.5秒後        |            |          |
 |          |            |              |            |            |          |
 |          |--条件3チェック: 発車時刻ベース        |            |          |
 |          |  (発車時刻 - メロディー時間 - ドア閉時間 - マージン)  |          |
 |          |            |              |            |            |          |
 |          |--FindTrackByCircuitIdAsync()          |            |          |
 |          |            |              |            |            |          |
 |          |            |              |<-TrackInfo|            |          |
 |          |            |              |            |            |          |
 |          |--GetMelodyDurationAsync(track)------->|            |          |
 |          |            |              |            |            |          |
 |          |            |              |            |--GetAudioDurationAsync()
 |          |            |              |            |            |          |
 |          |            |              |            |            |--FFmpeg実行
 |          |            |              |            |            |          |
 |          |            |              |            |            |<-Duration|
 |          |            |              |            |            |          |
 |          |            |              |            |<-duration--|          |
 |          |            |              |            |            |          |
 |          |<-duration-----------------------------|            |          |
 |          |            |              |            |            |          |
 |          |--発車時刻から逆算した開始時刻と現在時刻を比較      |          |
 |          |            |              |            |            |          |
 |          |--(条件満たす場合)         |            |            |          |
 |          |            |              |            |            |          |
 |          |--StartMelodyAsync()------>|            |            |          |
 |          |            |              |            |            |          |
 |          |            |--(SEQ-002と同様の処理)    |            |          |
 |          |            |              |            |            |          |
 |          |<-メロディー開始完了-------|            |            |          |
 |          |            |              |            |            |          |
 |          |--_melodyTriggered = true  |            |            |          |
 |          |            |              |            |            |          |
```

### 5.3 処理ステップ

1. Timerが16ms周期でTickイベント発火
2. `AutoModeService.CheckAndExecuteAsync()` が呼ばれる
3. 自動モード有効チェック
4. ゲーム状態取得（運転士モード、一時停止、在線チェック）
5. 到着/信号開通/ドア開の時刻を記録
6. メロディーON条件をチェック:
   - 条件1: 到着後1秒
   - 条件2: 信号開通0.5秒後
   - 条件3: 発車時刻ベース
7. 条件3のために、メロディー長さをFFmpegで取得
8. 発車時刻から逆算した開始時刻と現在時刻を比較
9. 条件を満たせば `MelodyControlService.StartMelodyAsync()` 呼び出し
10. メロディー開始完了、`_melodyTriggered = true` で重複起動防止

## 6. SEQ-005: 自動モード - メロディー停止

### 6.1 概要
自動モードで条件を満たした時にメロディーを自動停止する処理。

### 6.2 シーケンス図

```
Timer    AutoMode   MelodyControl  GameService  AudioPlayback
 |          |            |              |            |
 |--16ms周期|            |              |            |
 |          |            |              |            |
 |--Tick--->|            |              |            |
 |          |            |              |            |
 |          |--CheckAndExecuteAsync()   |            |
 |          |            |              |            |
 |          |--CheckMelodyOffConditions()|           |
 |          |            |              |            |
 |          |--GetCurrentState()------->|            |
 |          |            |              |            |
 |          |<-MelodyState              |            |
 |          |            |              |            |
 |          |--再生中チェック           |            |
 |          |            |              |            |
 |          |--条件1チェック: ON後最低1秒            |
 |          |(満たさなければreturn)     |            |
 |          |            |              |            |
 |          |--条件2チェック: ドア開後最低12秒       |
 |          |(満たさなければreturn)     |            |
 |          |            |              |            |
 |          |--条件3チェック: 発車時刻ベース        |
 |          |(発車時刻 - ドア閉時間 - マージン)     |
 |          |            |              |            |
 |          |--現在時刻が停止時刻を過ぎているか確認 |
 |          |            |              |            |
 |          |--(条件満たす場合)         |            |
 |          |            |              |            |
 |          |--StopMelodyAsync()------->|            |
 |          |            |              |            |
 |          |            |--(SEQ-003と同様の処理)    |
 |          |            |              |            |
 |          |<-メロディー停止完了-------|            |
 |          |            |              |            |
```

### 6.3 処理ステップ

1. Timerが16ms周期でTickイベント発火
2. `AutoModeService.CheckAndExecuteAsync()` が呼ばれる
3. `CheckMelodyOffConditions()` でメロディーOFF条件チェック
4. 現在のメロディー状態取得
5. 再生中かチェック
6. 条件チェック:
   - 条件1: ON後最低1秒（満たさなければreturn）
   - 条件2: ドア開後最低12秒（満たさなければreturn）
   - 条件3: 発車時刻ベース（発車時刻 - ドア閉時間 - マージン）
7. 条件を満たせば `MelodyControlService.StopMelodyAsync()` 呼び出し
8. メロディー停止、ドア閉め案内再生

## 7. SEQ-006: ゲーム一時停止検知

### 7.1 概要
ゲームが一時停止状態になった時に音声も一時停止する処理。

### 7.2 シーケンス図

```
GameService  MelodyControl  AudioPlayback  MediaPlayer
    |              |              |            |
    |--GameStateChanged イベント発火(IsPaused=true)
    |              |              |            |
    |------------->|              |            |
    |              |              |            |
    |              |--OnGameStateChanged()     |
    |              |              |            |
    |              |--IsPausedチェック         |
    |              |              |            |
    |              |--PauseAll()------------->|
    |              |              |            |
    |              |              |--Pause()-->|
    |              |              |            |
    |              |              |            |--Pause()
    |              |              |            |
    |              |              |<-一時停止--|
    |              |              |            |
    |              |<-一時停止完了-------------|
    |              |              |            |
    |              |              |            |
    |--GameStateChanged イベント発火(IsPaused=false)
    |              |              |            |
    |------------->|              |            |
    |              |              |            |
    |              |--OnGameStateChanged()     |
    |              |              |            |
    |              |--IsPausedチェック(false)  |
    |              |              |            |
    |              |--ResumeAll()------------>|
    |              |              |            |
    |              |              |--Resume()->|
    |              |              |            |
    |              |              |            |--Play()
    |              |              |            |
    |              |              |<-再開------|
    |              |              |            |
    |              |<-再開完了----------------|
    |              |              |            |
```

### 7.3 処理ステップ

1. `TraincrewGameService` がゲーム状態の変化を検知
2. `GameStateChanged` イベント発火（IsPaused=true）
3. `MelodyControlService.OnGameStateChanged()` が呼ばれる
4. IsPausedフラグをチェック
5. `AudioPlaybackService.PauseAll()` で全音声を一時停止
6. `MediaPlayerService.Pause()` でMediaPlayerを一時停止
7. ゲームが再開（IsPaused=false）
8. `GameStateChanged` イベント発火
9. `AudioPlaybackService.ResumeAll()` で全音声を再開
10. `MediaPlayerService.Resume()` でMediaPlayerを再開

## 8. SEQ-007: 駅からの離脱検知

### 8.1 概要
列車が駅を離れた時にメロディーを自動停止する処理。

### 8.2 シーケンス図

```
GameService  MelodyControl  AudioPlayback  MainWindow
    |              |              |            |
    |--GameStateChanged イベント発火(IsAtStation=false)
    |              |              |            |
    |------------->|              |            |
    |              |              |            |
    |              |--OnGameStateChanged()     |
    |              |              |            |
    |              |--IsAtStationチェック(false)
    |              |              |            |
    |              |--GetCurrentState()        |
    |              |--(IsPlaying チェック)     |
    |              |              |            |
    |              |--Log: "駅から離れたため、メロディーを停止"
    |              |              |            |
    |              |--StopMelody()----------->|
    |              |              |            |
    |              |              |--Stop()    |
    |              |              |            |
    |              |              |<-停止完了--|
    |              |              |            |
    |              |<-停止完了-----------------|
    |              |              |            |
    |              |--状態更新(IsPlaying=false)
    |              |              |            |
    |              |--StateChanged イベント発火
    |              |              |            |
    |              |-------------------------------->|
    |              |              |            |
    |              |              |            |--ボタン状態更新
    |              |              |            |  (両方無効化)
    |              |              |            |
```

### 7.3 処理ステップ

1. `TraincrewGameService` が駅からの離脱を検知
2. `GameStateChanged` イベント発火（IsAtStation=false）
3. `MelodyControlService.OnGameStateChanged()` が呼ばれる
4. IsAtStationフラグをチェック（false）
5. 現在の状態を取得、メロディー再生中かチェック
6. 再生中の場合、ログ記録
7. `AudioPlaybackService.StopMelody()` でメロディー停止
8. 状態更新（IsPlaying=false）
9. StateChangedイベント発火
10. MainWindowがイベントを受け取り、ボタンを無効化

## 9. シーケンス図の凡例

### 9.1 記号の意味

| 記号 | 意味 |
|-----|------|
| `----->` | 同期呼び出し |
| `- - ->` | 非同期呼び出し |
| `<-----` | 戻り値 |
| `[作成]` | オブジェクト生成 |
| `--Log:` | ログ出力 |

### 9.2 オブジェクト略称

| 略称 | 正式名称 |
|-----|---------|
| App | App.xaml.cs |
| MainWindow | MainWindow.xaml.cs |
| MelodyControl | MelodyControlService |
| AutoMode | AutoModeService |
| GameService | TraincrewGameService |
| TrackRepo | TrackRepository |
| AudioPlayback | AudioPlaybackService |
| MediaPlayer | MediaPlayerService |
| FFmpeg | FFmpegService |

## 10. まとめ

本シーケンス図では、以下の主要なユースケースの処理フローを定義した：

1. **アプリケーション起動**: DI構成からゲーム接続まで
2. **手動モード**: ユーザー操作によるメロディー制御
3. **自動モード**: タイマーベースの自動メロディー制御
4. **一時停止検知**: ゲーム状態に連動した音声制御
5. **駅離脱検知**: 駅を離れた時の自動停止

各シーケンスは、レイヤードアーキテクチャに従った明確な処理フローを持つ。
