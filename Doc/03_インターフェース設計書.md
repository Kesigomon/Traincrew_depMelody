# インターフェース設計書

## 1. 概要

### 1.1 目的
本書は、Traincrew発車メロディー連動システムの外部インターフェース仕様を詳細に定義する。

### 1.2 参照ドキュメント
- 要件定義書.md
- 01_システムアーキテクチャ設計書.md
- 02_クラス設計書.md

## 2. インターフェース種別

### 2.1 インターフェース一覧

| ID | インターフェース名 | 種別 | 方向 | 概要 |
|----|------------------|------|------|------|
| IF-001 | UI入力インターフェース | UI | 入力 | ユーザーからのボタン操作 |
| IF-002 | UI表示インターフェース | UI | 出力 | ボタン状態・情報表示 |
| IF-003 | WebSocket通信 | 通信 | 双方向 | Traincrewゲームサーバーとの通信 |
| IF-004 | TrainCrewInput.dll | DLL | 入力 | ゲーム状態取得 |
| IF-005 | Track.csv入力 | ファイル | 入力 | 駅・番線マスタデータ |
| IF-006 | AudioProfile.csv入力 | ファイル | 入力 | 音声ファイルパス設定 |
| IF-007 | 音声ファイル入力 | ファイル | 入力 | メロディー・案内音声 |
| IF-008 | 音声出力 | デバイス | 出力 | スピーカーへの音声出力 |
| IF-009 | FFmpeg連携 | プロセス | 入力 | 音声ファイル解析 |
| IF-010 | ログ出力 | ファイル | 出力 | アプリケーションログ |

## 3. UI入力インターフェース (IF-001)

### 3.1 概要
ユーザーがメインウィンドウのボタンを操作してメロディー制御を行う。

### 3.2 UI要素仕様

#### 3.2.1 ONボタン

| 項目 | 仕様 |
|-----|------|
| コントロール名 | ON |
| 表示ラベル | "ON" |
| サイズ | ウィンドウ上半分全体（Stretch） |
| フォントサイズ | 72pt |
| 背景色（有効時） | 黒（Black） |
| 前景色 | 白（White） |
| 配置 | Grid.Row="0" |
| 有効条件 | 駅に在線 AND 一時停止中でない AND メロディー再生中でない AND 自動モードOFF |
| 無効条件 | 上記以外 |
| クリック時動作 | `ButtonPressed` イベントハンドラで `MelodyControlService.StartMelodyAsync()` を呼び出し |

#### 3.2.2 OFFボタン

| 項目 | 仕様 |
|-----|------|
| コントロール名 | OFF |
| 表示ラベル | "OFF" |
| サイズ | ウィンドウ下半分全体（Stretch） |
| フォントサイズ | 72pt |
| 背景色（有効時） | 赤（Red） |
| 前景色 | 白（White） |
| 配置 | Grid.Row="1" |
| 有効条件 | メロディー再生中 AND 自動モードOFF |
| 無効条件 | 上記以外 |
| クリック時動作 | `ButtonPressed` イベントハンドラで `MelodyControlService.StopMelodyAsync()` を呼び出し |

### 3.3 イベントフロー

```
[ユーザー] → [ボタンクリック] → [イベントハンドラ] → [MelodyControlService] → [処理実行]
```

### 3.4 エラーハンドリング

| エラー種別 | UI表示 | ログレベル |
|-----------|--------|-----------|
| 駅に在線していない | MessageBox警告 | Warning |
| 音声ファイル未存在 | MessageBox エラー | Error |
| ゲームとの通信エラー | MessageBox エラー | Error |

## 4. UI表示インターフェース (IF-002)

### 4.1 概要
システム状態をユーザーに視覚的にフィードバックする。

### 4.2 ウィンドウ仕様

| 項目 | 仕様 |
|-----|------|
| ウィンドウタイトル | "Traincrew depMelody" |
| サイズ | 幅: 350px, 高さ: 700px |
| リサイズ | 不可 |
| 最前面表示 | ユーザー設定可能（将来機能） |
| 背景色 | システムデフォルト |

### 4.3 ボタン状態表示

| 状態 | ONボタン表示 | OFFボタン表示 |
|-----|-------------|--------------|
| 駅外 | 無効（グレーアウト） | 無効（グレーアウト） |
| 駅内・メロディーOFF | 有効（黒背景・白文字） | 無効（グレーアウト） |
| 駅内・メロディーON | 無効（グレーアウト） | 有効（赤背景・白文字） |
| 一時停止中 | 無効（グレーアウト） | 無効（グレーアウト） |
| 自動モードON | 無効（グレーアウト） | 無効（グレーアウト） |

### 4.4 将来の表示項目（開発者モード）

| 表示項目 | 内容 |
|---------|------|
| 現在駅名 | 例: "館浜駅" |
| 現在番線 | 例: "1番線" |
| メロディー状態 | 例: "再生中" / "停止中" |
| 自動モード状態 | 例: "ON" / "OFF" |
| 軌道回路ID | 例: "TC_001" |

## 5. WebSocket通信 (IF-003)

### 5.1 概要
Traincrewゲームサーバーと WebSocket でリアルタイムに軌道回路情報を取得する。

### 5.2 接続仕様

| 項目 | 仕様 |
|-----|------|
| プロトコル | WebSocket (RFC 6455) |
| ホスト | localhost |
| ポート | 50300（設定可能） |
| URI | ws://localhost:50300 |
| 自動再接続 | 有効（5秒間隔でリトライ） |
| タイムアウト | 10秒 |

### 5.3 メッセージフォーマット

#### 5.3.1 受信メッセージ（ゲームサーバー → 本システム）

**軌道回路情報**

```json
{
  "type": "circuit_info",
  "timestamp": "2025-10-22T10:30:45Z",
  "data": {
    "current_circuit_id": "TC_001",
    "speed": 0.0,
    "location": {
      "latitude": 35.681236,
      "longitude": 139.767125
    }
  }
}
```

| フィールド | 型 | 必須 | 説明 |
|-----------|---|------|------|
| type | string | ○ | メッセージ種別（"circuit_info"） |
| timestamp | string (ISO 8601) | ○ | タイムスタンプ |
| data.current_circuit_id | string | ○ | 現在在線中の軌道回路ID |
| data.speed | number | ○ | 速度 (km/h) |
| data.location | object | × | 位置情報（オプション） |

#### 5.3.2 送信メッセージ（本システム → ゲームサーバー）

本システムからの送信は基本的になし（受信専用）。
将来的にはハートビートメッセージを送信する可能性がある。

### 5.4 エラーハンドリング

| エラー種別 | 対応 |
|-----------|------|
| 接続失敗 | 5秒後に自動再接続 |
| 切断 | 5秒後に自動再接続 |
| タイムアウト | 切断して再接続 |
| 不正なJSON | ログ記録してスキップ |

## 6. TrainCrewInput.dll (IF-004)

### 6.1 概要
Traincrewゲーム内部の状態情報を取得するためのネイティブDLL。

### 6.2 DLL仕様

| 項目 | 仕様 |
|-----|------|
| ファイル名 | TrainCrewInput.dll |
| アーキテクチャ | x64 |
| 呼び出し規約 | Cdecl |
| 配置場所 | 実行ファイルと同じディレクトリ |

### 6.3 エクスポート関数

#### 6.3.1 GetGameScreen

**シグネチャ**:
```c
int GetGameScreen();
```

**説明**: 現在のゲーム画面種別を取得

**戻り値**:
| 値 | 意味 |
|----|------|
| 0 | Menu |
| 1 | Driving（運転士モード） |
| 2 | Conducting（車掌モード） |
| 3 | Other |

#### 6.3.2 IsPaused

**シグネチャ**:
```c
bool IsPaused();
```

**説明**: ゲームが一時停止中かどうか

**戻り値**:
- `true`: 一時停止中
- `false`: 通常動作中

#### 6.3.3 GetCrewType

**シグネチャ**:
```c
int GetCrewType();
```

**説明**: 乗務員種別を取得

**戻り値**:
| 値 | 意味 |
|----|------|
| 0 | None（非乗務） |
| 1 | Driver（運転士） |
| 2 | Conductor（車掌） |

#### 6.3.4 GetTrainSpeed

**シグネチャ**:
```c
double GetTrainSpeed();
```

**説明**: 列車速度を取得 (km/h)

**戻り値**: 速度 (km/h)

#### 6.3.5 IsDoorsOpen

**シグネチャ**:
```c
bool IsDoorsOpen();
```

**説明**: ドアが開いているか

**戻り値**:
- `true`: ドア開
- `false`: ドア閉

#### 6.3.6 GetTrainNumber

**シグネチャ**:
```c
const char* GetTrainNumber();
```

**説明**: 列車番号を取得（例: "1234M"）

**戻り値**: 列車番号文字列（NULL終端）

#### 6.3.7 GetVehicleType

**シグネチャ**:
```c
const char* GetVehicleType();
```

**説明**: 車両形式を取得（例: "50000"）

**戻り値**: 車両形式文字列（NULL終端）

#### 6.3.8 GetDepartureTime

**シグネチャ**:
```c
int GetDepartureTime();
```

**説明**: 発車時刻を取得（Unix時間）

**戻り値**: Unix timestamp (秒)、未設定時は 0

#### 6.3.9 GetSignalAspect

**シグネチャ**:
```c
int GetSignalAspect();
```

**説明**: 前方信号の現示を取得

**戻り値**:
| 値 | 意味 |
|----|------|
| 0 | 停止 |
| 1 | 注意 |
| 2 | 減速 |
| 3 | 進行 |
| 4 | 高速進行 |

### 6.4 P/Invoke 定義例

```csharp
[DllImport("TrainCrewInput.dll", CallingConvention = CallingConvention.Cdecl)]
private static extern int GetGameScreen();

[DllImport("TrainCrewInput.dll", CallingConvention = CallingConvention.Cdecl)]
private static extern bool IsPaused();

[DllImport("TrainCrewInput.dll", CallingConvention = CallingConvention.Cdecl)]
private static extern int GetCrewType();

[DllImport("TrainCrewInput.dll", CallingConvention = CallingConvention.Cdecl)]
private static extern double GetTrainSpeed();

[DllImport("TrainCrewInput.dll", CallingConvention = CallingConvention.Cdecl)]
private static extern bool IsDoorsOpen();

[DllImport("TrainCrewInput.dll", CallingConvention = CallingConvention.Cdecl, CharSet = CharSet.Ansi)]
private static extern IntPtr GetTrainNumber();

[DllImport("TrainCrewInput.dll", CallingConvention = CallingConvention.Cdecl, CharSet = CharSet.Ansi)]
private static extern IntPtr GetVehicleType();

[DllImport("TrainCrewInput.dll", CallingConvention = CallingConvention.Cdecl)]
private static extern int GetDepartureTime();

[DllImport("TrainCrewInput.dll", CallingConvention = CallingConvention.Cdecl)]
private static extern int GetSignalAspect();
```

## 7. CSVファイル入力 (IF-005)

### 7.1 概要
駅・番線と軌道回路の対応マスタデータをCSV形式で管理する。

### 7.2 ファイル仕様

| 項目 | 仕様 |
|-----|------|
| ファイル名 | Track.csv |
| 文字コード | UTF-8 (BOM無し) |
| 改行コード | CRLF または LF |
| 配置場所 | `.\Csv\Track.csv` |
| 区切り文字 | カンマ (,) |

### 7.3 フォーマット

#### 7.3.1 ヘッダー行

```
駅名,番線,対応軌道回路1,対応軌道回路2,対応軌道回路3
```

#### 7.3.2 データ行

```
館浜,1,TC_001,TC_002,
館浜,2,TC_003,TC_004,TC_005
海浜幕張,1,TC_101,,
海浜幕張,2,TC_102,TC_103,
```

### 7.4 カラム定義

| カラム位置 | カラム名 | 型 | 必須 | 最大長 | 説明 |
|-----------|---------|---|------|-------|------|
| 1 | 駅名 | string | ○ | 50 | 駅の名称 |
| 2 | 番線 | string | ○ | 10 | 番線番号（例: "1", "2"） |
| 3 | 対応軌道回路1 | string | ○ | 20 | この番線に対応する軌道回路ID（1つ目） |
| 4 | 対応軌道回路2 | string | × | 20 | この番線に対応する軌道回路ID（2つ目、任意） |
| 5 | 対応軌道回路3 | string | × | 20 | この番線に対応する軌道回路ID（3つ目、任意） |

### 7.5 制約事項

- ヘッダー行は1行目に必須
- 駅名と番線の組み合わせは一意である必要がある
- 軌道回路IDは重複不可（異なる番線に同じ軌道回路IDを割り当てることは不可）
- 空行は無視される
- カンマを含む値は引用符で囲む必要がある（例: `"駅名,テスト"`）

### 7.6 バリデーション

| 検証項目 | エラー時の動作 |
|---------|--------------|
| ファイルが存在しない | 例外スロー（アプリ起動失敗） |
| 文字コードが不正 | ログ記録、読み込みスキップ |
| カラム数不足 | 該当行をスキップ、警告ログ |
| 駅名・番線が空 | 該当行をスキップ、警告ログ |
| 軌道回路1が空 | 該当行をスキップ、警告ログ |
| 駅名・番線重複 | 後勝ち（上書き）、警告ログ |

### 7.7 サンプルデータ

```csv
駅名,番線,対応軌道回路1,対応軌道回路2,対応軌道回路3
館浜,1,TC_TATEHAMA_01_1,TC_TATEHAMA_01_2,
館浜,2,TC_TATEHAMA_02_1,TC_TATEHAMA_02_2,TC_TATEHAMA_02_3
海浜幕張,1,TC_KAIHINMAKUHARI_01,,
海浜幕張,2,TC_KAIHINMAKUHARI_02,,
稲毛海岸,1,TC_INAGEKAIGAN_01,,
稲毛海岸,2,TC_INAGEKAIGAN_02,,
```

## 8. AudioProfile.csv入力 (IF-006)

### 8.1 概要
駅・番線ごとの音声ファイルパスをCSV形式で管理する。

### 8.2 ファイル仕様

| 項目 | 仕様 |
|-----|------|
| ファイル名 | AudioProfile.csv |
| 文字コード | UTF-8 (BOM無し) |
| 改行コード | CRLF または LF |
| 配置場所 | `.\Csv\AudioProfile.csv` |
| 区切り文字 | カンマ (,) |

### 8.3 フォーマット

#### 8.3.1 ヘッダー行

```
駅名,番線,メロディーファイルパス,ドア閉め案内ファイルパス(下り),ドア閉め案内ファイルパス(上り)
```

#### 8.3.2 データ行

```
館浜,1,C:\Audio\Melody\tatehama_1.mp3,C:\Audio\Announcement\announcement1d.mp3,C:\Audio\Announcement\announcement1u.mp3
館浜,2,C:\Audio\Melody\tatehama_2.mp3,C:\Audio\Announcement\announcement2d.mp3,C:\Audio\Announcement\announcement2u.mp3
海浜幕張,1,C:\Audio\Melody\kaihinmakuhari.mp3,C:\Audio\Announcement\announcement1d.mp3,C:\Audio\Announcement\announcement1u.mp3
```

### 8.4 カラム定義

| カラム位置 | カラム名 | 型 | 必須 | 説明 |
|-----------|---------|---|------|------|
| 1 | 駅名 | string | ○ | 駅の名称 |
| 2 | 番線 | string | ○ | 番線番号（例: "1", "2"） |
| 3 | メロディーファイルパス | string | ○ | 発車メロディーの音声ファイルパス（絶対パスまたは相対パス） |
| 4 | ドア閉め案内ファイルパス(下り) | string | × | 下り方向のドア閉め案内音声ファイルパス（任意） |
| 5 | ドア閉め案内ファイルパス(上り) | string | × | 上り方向のドア閉め案内音声ファイルパス（任意） |

### 8.5 制約事項

- ヘッダー行は1行目に必須
- 駅名と番線の組み合わせは一意である必要がある
- メロディーファイルパスは必須
- ドア閉め案内ファイルパスは任意（空欄可）
- 空行は無視される
- カンマを含む値は引用符で囲む必要がある
- 絶対パスまたは相対パス（実行フォルダからの相対）で指定可能
- 同じメロディーファイルを複数の駅・番線で共有可能

### 8.6 バリデーション

| 検証項目 | エラー時の動作 |
|---------|--------------|
| ファイルが存在しない | 例外スロー（アプリ起動失敗） |
| 文字コードが不正 | ログ記録、読み込みスキップ |
| カラム数不足 | 該当行をスキップ、警告ログ |
| 駅名・番線が空 | 該当行をスキップ、警告ログ |
| メロディーファイルパスが空 | 該当行をスキップ、警告ログ |
| 駅名・番線重複 | 後勝ち（上書き）、警告ログ |

### 8.7 サンプルデータ

```csv
駅名,番線,メロディーファイルパス,ドア閉め案内ファイルパス(下り),ドア閉め案内ファイルパス(上り)
館浜,1,.\Audio\Melody\tatehama_1.mp3,.\Audio\Announcement\announcement1d.mp3,.\Audio\Announcement\announcement1u.mp3
館浜,2,.\Audio\Melody\tatehama_2.mp3,.\Audio\Announcement\announcement2d.mp3,.\Audio\Announcement\announcement2u.mp3
海浜幕張,1,.\Audio\Melody\kaihinmakuhari.mp3,.\Audio\Announcement\announcement1d.mp3,.\Audio\Announcement\announcement1u.mp3
海浜幕張,2,.\Audio\Melody\kaihinmakuhari.mp3,.\Audio\Announcement\announcement2d.mp3,.\Audio\Announcement\announcement2u.mp3
稲毛海岸,1,.\Audio\Melody\inagekaigan.mp3,,
```

**注**: 稲毛海岸の例のように、ドア閉め案内ファイルパスは省略可能。その場合、ドア閉め案内は再生されない。

## 9. 音声ファイル入力 (IF-007)

### 9.1 概要
AudioProfile.csvで指定された音声ファイルを読み込む。

### 9.2 ファイル仕様

| 項目 | 仕様 |
|-----|------|
| フォーマット | MP3 または WAV |
| サンプルレート | 44.1kHz 推奨 |
| ビットレート | 128kbps 以上（MP3の場合） |
| チャンネル | ステレオ または モノラル |
| 配置場所 | AudioProfile.csvで指定されたパス |

### 9.3 特殊ファイル

| ファイル名 | 用途 | 配置場所 |
|-----------|------|---------|
| `default.mp3` | AudioProfileが見つからない場合のデフォルトメロディー | `.\Audio\default.mp3` |

### 9.4 エラーハンドリング

| エラー種別 | 対応 |
|-----------|------|
| AudioProfileが見つからない | デフォルトメロディーを使用、警告ログ |
| メロディーファイル未存在 | デフォルトメロディーを使用、警告ログ |
| デフォルトメロディー未存在 | 例外スロー |
| 案内ファイル未存在 | 案内再生をスキップ、警告ログ |
| ファイル形式不正 | エラーログ、再生失敗 |

## 10. 音声出力 (IF-008)

### 10.1 概要
システムの既定音声出力デバイスに音声を出力する。

### 10.2 出力仕様

| 項目 | 仕様 |
|-----|------|
| 出力デバイス | Windowsシステム既定の音声出力 |
| 音量制御 | MediaPlayer.Volume (0.0 ～ 1.0) |
| 同時再生 | メロディープレーヤー1つ + 案内プレーヤー1つ |

### 10.3 再生モード

| モード | 対象 | 動作 |
|-------|------|------|
| ループ再生 | メロディー | 再生終了時に自動的に先頭から再生 |
| 1回再生 | ドア閉め案内 | 再生終了で停止 |

### 10.4 一時停止制御

ゲームが一時停止状態になった場合、音声も一時停止し、再開時に再開する。

## 11. FFmpeg連携 (IF-009)

### 11.1 概要
FFmpegを外部プロセスとして起動し、音声ファイルの長さを取得する。

### 11.2 実行仕様

| 項目 | 仕様 |
|-----|------|
| FFmpeg実行ファイル | `C:\ffmpeg\bin\ffmpeg.exe`（設定可能） |
| 実行方式 | Process.Start() |
| タイムアウト | 5秒 |

### 11.3 コマンドライン

```bash
ffmpeg -i "{音声ファイルパス}" -hide_banner
```

### 11.4 出力パース

FFmpegの標準エラー出力から以下の行を抽出：

```
Duration: 00:00:35.50, start: 0.000000, bitrate: 128 kb/s
```

**正規表現**:
```regex
Duration: (\d{2}):(\d{2}):(\d{2}\.\d{2})
```

**抽出例**:
- グループ1: `00` (時)
- グループ2: `00` (分)
- グループ3: `35.50` (秒)

→ 合計: 35.50秒

### 11.5 エラーハンドリング

| エラー種別 | 対応 |
|-----------|------|
| FFmpeg実行ファイル未存在 | エラーログ、null返却 |
| タイムアウト | エラーログ、null返却 |
| パース失敗 | エラーログ、null返却 |
| ファイル未存在 | 警告ログ、null返却 |

## 12. ログ出力 (IF-010)

### 12.1 概要
アプリケーションの動作ログをファイルに出力する。

### 12.2 ログファイル仕様

| 項目 | 仕様 |
|-----|------|
| 出力先ディレクトリ | `.\Logs\` |
| ファイル名形式 | `app-{日付}.log` (例: `app-20251022.log`) |
| 文字コード | UTF-8 |
| ローテーション | 日次（日付が変わると新ファイル） |
| 保持期間 | 30日間（古いログは自動削除） |

### 11.3 ログフォーマット

```
[{タイムスタンプ}] [{ログレベル}] [{カテゴリ}] {メッセージ}
```

**例**:
```
[2025-10-22 10:30:45.123] [INFO] [MelodyControlService] メロディー再生開始: 館浜 1番線
[2025-10-22 10:30:46.456] [ERROR] [AudioPlaybackService] 音声ファイルが見つかりません: .\Audio\Melody\館浜_3.mp3
```

### 11.4 ログレベル別の出力内容

| レベル | 出力内容例 |
|-------|-----------|
| Trace | メソッド呼び出しトレース、詳細な変数値 |
| Debug | 状態遷移、条件分岐、タイマーイベント |
| Information | メロディー開始/停止、ゲーム接続/切断 |
| Warning | デフォルトメロディー使用、ファイル未存在 |
| Error | 音声再生失敗、WebSocket切断 |
| Critical | アプリケーション起動失敗、致命的エラー |

## 12. 設定ファイル

### 12.1 設定ファイル入力

**ファイル名**: `appsettings.json`

**フォーマット**:
```json
{
  "FFmpegPath": "C:\\ffmpeg\\bin\\ffmpeg.exe",
  "AudioBaseDirectory": ".\\Audio",
  "TrackCsvPath": ".\\Csv\\Track.csv",
  "WebSocketPort": 50300,
  "GameStatePollingIntervalMs": 16,
  "DefaultMelodyFileName": "default.mp3",
  "LogDirectory": ".\\Logs",
  "DeveloperMode": false
}
```

### 12.2 キーボード入力（将来機能）

グローバルホットキーによるメロディー制御。

| キー | 動作 |
|-----|------|
| 設定可能なキー | ONボタン相当 |
| 設定可能なキー | OFFボタン相当 |

### 12.3 シリアルポート入力（将来機能）

実際の発車ベルスイッチをシリアルポート経由で接続。

| 項目 | 仕様 |
|-----|------|
| ボーレート | 9600 |
| データビット | 8 |
| パリティ | なし |
| ストップビット | 1 |
| フロー制御 | なし |

## 13. まとめ

本インターフェース設計書では、以下を詳細に定義した：

1. **UI入出力**: ボタン操作と状態表示
2. **外部システム連携**: WebSocket、DLL、CSV、音声ファイル
3. **デバイス出力**: 音声出力
4. **外部プロセス**: FFmpeg
5. **ログ出力**: アプリケーションログ

各インターフェースは明確なフォーマットと仕様を持ち、エラーハンドリングも定義されている。
