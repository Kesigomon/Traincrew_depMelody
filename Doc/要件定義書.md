# 要件定義書

## 1. システム概要

### 1.1 システム名称
Traincrew発車メロディー連動システム (Traincrew_depMelody)

### 1.2 システム目的
JR東日本で使用されている発車メロディースイッチを、ゲーム「Traincrew」と連動して再現し、車掌業務の臨場感を高めることを目的とする。

### 1.3 想定利用者
- Traincrewプレイヤー（特に車掌モードおよび運転士モード）

## 2. 機能要件

### 2.1 基本機能

#### 2.1.1 発車メロディー再生機能（手動モード）
- **機能概要**: UIのON/OFFボタンで発車メロディーを制御する
- **詳細要件**:
  - UI上にONボタンとOFFボタンを配置
  - 駅に在線していない場合、両ボタンを無効化
  - ONボタン押下時、発車メロディーの再生を開始
  - OFFボタン押下時、発車メロディーを停止し、「X番線、ドアが閉まります」の音声を再生
  - 同じボタンの連打では処理を実行しない（状態変化時のみ動作）
  - ONからOFFまたはOFFからONへの遷移時のみ音声処理を実行

#### 2.1.2 Traincrewゲーム連動機能
- **機能概要**: Traincrewゲームの状態をリアルタイムで取得し、システムの動作を制御
- **詳細要件**:
  - ゲームの乗務状態（プレイ中/非プレイ中）を検知
  - 駅への在線状態を検知
  - 在線中の駅名・番線を取得
  - 乗務員種別（運転士/車掌）を取得
  - ゲームの一時停止状態を検知
  - 軌道回路情報を取得してホームトラック判定を実施
  - WebSocket（ポート50300）経由でゲームサーバーと通信
  - TrainCrewInput.dllを使用してゲーム状態を取得

#### 2.1.3 駅・番線別メロディー管理機能
- **機能概要**: 駅と番線に応じて異なる発車メロディーを再生
- **詳細要件**:
  - CSVファイル（stations.csv）で駅名・番線・軌道回路の対応を管理
  - プロファイルCSVで駅名・番線ごとの音声ファイルパスを管理
  - 駅名と番線、および列車の上り/下りに基づいて適切な音声ファイルを選択
  - メロディーファイルが存在しない場合、デフォルトメロディーを使用
  - 「ドアが閉まります」音声も番線および上り/下りにより変化
  - 特定駅（館浜駅）では列車種別により使用する番線を動的に変更

### 2.2 自動モード機能

#### 2.2.1 自動メロディー再生機能
- **機能概要**: 運転士モードでプレイ時、車掌が乗務している設定で自動的にメロディーを鳴らす
- **詳細要件**:
  - 運転士モード時に自動モードを有効化
  - 自動モード有効時はUIボタンを無効化
  - 以下の条件を満たした場合にONボタン相当の処理を実行:
    - 電車到着後1秒後
    - 信号開通0.5秒後
    - 発車時刻 - メロディ時間 - ドア閉まる時間 - マージン
  - 以下の条件を満たした場合にOFFボタン相当の処理を実行:
    - ONを押してから最低でも1秒後
    - ドアが開いてから最低でも12秒後
    - 発車時刻 - ドア閉まる時間 - マージン
  - メロディー再生時間をFFmpegで事前取得
    - これは、MediaPlayerによるLengthを取得する実装だと、長さが不正であることがあったため。
  - 車両形式により動作マージンを調整（50000系の場合16.5秒、その他8.5秒）

### 2.3 音声再生機能

#### 2.3.1 メロディー再生機能
- **機能概要**: 発車メロディーをループ再生する
- **詳細要件**:
  - MediaPlayerを使用して音声を再生
  - メロディーは再生終了時に自動的にループ
  - OFF押下時にループを停止

#### 2.3.2 ドア閉め案内音声再生機能
- **機能概要**: 「X番線、ドアが閉まります」の音声を再生
- **詳細要件**:
  - メロディー停止後1秒後に再生開始
  - 再生は1回のみ（ループなし）

#### 2.3.3 一時停止対応機能
- **機能概要**: ゲームの一時停止に連動して音声を一時停止/再開
- **詳細要件**:
  - ゲームがPause状態になったら音声を一時停止
  - Pauseから復帰したら音声を再開
  - Pause中はUIボタンを無効化

## 3. 非機能要件

### 3.1 性能要件
- ゲーム状態の取得周期: 16ミリ秒（約60FPS相当）
- ボタン押下から音声再生までの遅延: 1秒以内

### 3.2 拡張性要件
- 新規駅・番線の追加をCSV編集のみで対応可能
- メロディーファイルの追加を音声ファイル配置のみで対応可能

### 3.3 保守性要件
- 依存性注入（DI）によるコンポーネント間の疎結合化
- Repository/Serviceパターンによる責務の分離
- インターフェースを介した実装の抽象化

## 4. 外部インターフェース

### 4.1 入力インターフェース

#### 4.1.1 UIボタン入力
- ONボタン: 発車メロディー再生開始
- OFFボタン: 発車メロディー停止＆ドア閉め案内再生

#### 4.1.2 Traincrewゲーム連携
- WebSocket通信（ポート50300）
  - 軌道回路情報の取得
- TrainCrewInput.dll
  - ゲーム状態（GameScreen）の取得
  - 列車状態（TrainState）の取得
  - 信号情報（SignalInfo）の取得
  - 乗務員種別（CrewType）の取得

#### 4.1.3 CSVファイル入力
- stations.csv
  - カラム: 駅名, 番線, 対応軌道回路1, 対応軌道回路2, 対応軌道回路3
  - 文字コード: UTF-8
  - 配置場所: `実行フォルダ\stations\stations.csv`
- プロファイルCSV（例: default.csv）
  - カラム: 駅名, 番線, メロディーファイルパス(下り), メロディーファイルパス(上り), ドア閉め案内ファイルパス(下り), ドア閉め案内ファイルパス(上り)
  - 文字コード: UTF-8
  - 配置場所: `実行フォルダ\profiles\{プロファイル名}.csv`
  - 使用するプロファイルはappsettings.jsonで指定

#### 4.1.4 音声ファイル入力
- 発車メロディー
  - ファイル形式: MP3/WAV
  - 配置場所: プロファイルCSVで指定されたパス
  - 上り列車用と下り列車用を別々に指定可能
- ドア閉め案内
  - ファイル形式: MP3/WAV
  - 命名規則例: `announce{番線}d.mp3`（下り）、`announce{番線}u.mp3`（上り）
  - 配置場所: プロファイルCSVで指定されたパス

### 4.2 出力インターフェース

#### 4.2.1 音声出力
- システム既定の音声出力デバイスへ音声を出力

#### 4.2.2 UI表示
- ウィンドウサイズ: 350x700ピクセル
- ボタン有効/無効状態の視覚的フィードバック
- 最前面表示の制御

## 5. 制約事項

### 5.1 動作環境
- OS: Windows
- .NET: 8.0以降
- Traincrewゲームが起動している必要がある
- FFmpegがインストールされている必要がある（自動モード使用時）

### 5.2 既知の制限
- 音声ファイルパスが現在ハードコード(今回の開発で改善。設定ファイルで。)
- FFmpegのパスもハードコード(今回の開発で改善する)
- 上り/下り判定が未実装（列車番号から判定可能、実装予定）

## 6. 将来的な追加機能（仕様書より）

### 6.1 設定Window（GUI設定機能）
**優先度**: 高
- キーボード操作設定
  - 操作モード選択（モード1-4）
  - キーバインド設定（グローバルホットキー）
- 自動モード設定
  - 自動モード条件（常時ON / 運転士のみON / 常時OFF）
  - 強制ON/OFF切り替え
- その他設定
  - FFmpegパス設定
  - 音声ベースディレクトリ設定
  - 開発者モード（デバッグ情報表示）

### 6.2 設定ファイルによる音声パス管理機能
**優先度**: 高
- CSVなどの設定ファイルで音声ファイルパスを自由に指定可能
- 同じメロディーを複数駅で共有可能

### 6.3 キーボード操作機能（グローバルホットキー）
**優先度**: 高
- 4つの操作モード(設定で切換可能)
  - モード1: キーボードを使わない
  - モード2: 特定の2つのキーを使って、一方のキーを押すとON、もう一方のキーを押すとOFF
  - モード3: 特定のキー押しでON、離すとOFF
  - モード4: 特定のキー押しでON、もう一度同じキーを押すとOFF
- 特定のキーは、設定で変更可能
  - 設定画面で、ボタンを押した後にキーを押してもらい、そのキーを登録
- グローバルホットキーとして実装（他アプリにフォーカスがあっても動作）
- 自動モード時は無効化

### 6.4 開発者向けモード
**優先度**: 低
- 現在駅・番線の表示
- 自動モードON/OFF状態の表示
- メロディー再生状態の表示
- デバッグ用情報の表示
- 通常はユーザーに表示しない（設定で有効化）

### 6.5 音量調整機能
**優先度**: 低（オプション）
- メロディー音量の調整
- ドア閉め案内音量の調整
- 設定Windowで調整可能

## 7. 用語集

| 用語 | 説明 |
|------|------|
| Traincrew | 本システムが連動する電車運転シミュレーションゲーム |
| 軌道回路 | 列車の位置を検知するための線路上の区間 |
| ホームトラック | 駅のホームに該当する軌道回路 |
| 在線 | 列車が特定の軌道回路上に存在すること |
| 発車メロディー | 列車発車時にホームで流れるメロディー |
| 車掌 | 列車のドア開閉や案内放送を担当する乗務員 |
| 運転士 | 列車の運転を担当する乗務員 |
| 自動モード | 運転士モード時に車掌業務を自動化するモード |
